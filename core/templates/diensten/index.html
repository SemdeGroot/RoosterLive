{% extends "base.html" %}
{% load static i18n %}

{% block title %}Diensten{% endblock %}
{% block header_title %}Diensten{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{% static 'css/base/table.css' %}">
  <link rel="stylesheet" href="{% static 'css/diensten/diensten.css' %}">
{% endblock %}

{% block content %}
<div class="card">
  <div class="form">

          <div class="birthday-header agenda-section-header">
        <img src="{% static 'img/diensten.svg' %}" alt="" class="birthday-icon">
        <div class="birthday-header-text">
        <h2>Diensten bekijken</h2>
        <p>Kies een week om je toegewezen diensten en locaties te zien. Synchroniseer onderaan eenmalig met je agenda app.</p>
        </div>
        <a href="{% url 'personeel_tiles' %}" class="btn btn-save">
          Terug naar Personeel
        </a>
      </div>
      <hr class="crud-divider">

    <!-- Weeknavigatie-->
    <div class="week-controls">
      <button id="prevWeekBtn"
              class="btn btn-icon"
              {% if not has_prev %}disabled aria-disabled="true"{% endif %}
              data-target="{{ prev_monday|date:'Y-m-d' }}"
              aria-label="Vorige week">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
             class="lucide lucide-arrow-left-icon lucide-arrow-left">
          <path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>
        </svg>
      </button>

      <div class="week-picker">
        <button id="weekPickerBtn"
                class="btn week-picker-btn"
                aria-haspopup="listbox"
                aria-expanded="false"
                aria-controls="weekMenu">
          <span class="wp-label">{{ header_title }}</span>
          <span class="wp-caret" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="lucide lucide-chevron-down">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </span>
        </button>

        <div id="weekMenu" class="week-menu" role="listbox" tabindex="-1" hidden>
          {% for opt in week_options %}
            <div role="option"
                 class="week-option{% if opt.value == monday|date:'Y-m-d' %} is-active{% endif %}"
                 data-value="{{ opt.value }}"
                 aria-selected="{% if opt.value == monday|date:'Y-m-d' %}true{% else %}false{% endif %}">
              <strong>Week {{ opt.iso_week }} – {{ opt.iso_year }}</strong>
              <small>({{ opt.start|date:"d-m" }} – {{ opt.end|date:"d-m" }})</small>
            </div>
          {% endfor %}
        </div>
      </div>

      <button id="nextWeekBtn"
              class="btn btn-icon"
              {% if not has_next %}disabled aria-disabled="true"{% endif %}
              data-target="{{ next_monday|date:'Y-m-d' }}"
              aria-label="Volgende week">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
             class="lucide lucide-arrow-right-icon lucide-arrow-right">
          <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
        </svg>
      </button>
    </div>

    <div class="availability-daterange">
      {{ monday|date:"d-m-Y" }} – {{ week_end|date:"d-m-Y" }}
    </div>

    <!-- DIENSTEN TABEL -->
    <div class="table-scroll">
      <table class="crud-table compact mijndiensten-table" aria-label="Mijn diensten">
        <thead>
          <tr>
            <th>Dag</th>
            <th>Dagdeel</th>
            <th>Locatie</th>
            <th>Taak</th>
          </tr>
        </thead>
        <tbody>
          {% if rows %}
            {% for r in rows %}
              <tr class="{% if not r.is_assigned %}is-empty{% endif %} {{ r.row_class }}">
                <td>
                  {% if r.show_day %}
                    <div class="weekday-title">
                      <strong>{{ r.date|date:"D"|capfirst }}</strong>
                      <small>{{ r.date|date:"d-m" }}</small>
                    </div>
                  {% else %}
                    <span class="day-blank" aria-hidden="true"></span>
                  {% endif %}
                </td>

                <td>
                  <div class="weekday-title">
                    <strong>{{ r.period_label }}</strong>
                    <small>{{ r.period_time }}</small>
                  </div>
                </td>

                <td class="wrap">
                  {% if r.location %}
                    {{ r.location }}
                  {% else %}
                    <span class="dash">—</span>
                  {% endif %}
                </td>

                <td class="wrap">
                  {% if r.task %}
                    {{ r.task }}
                  {% else %}
                    <span class="dash">—</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="4" class="wrap">
                Geen diensten gevonden voor deze week.
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- ADRES TABEL (onder diensten tabel) -->
    <div class="table-scroll" style="margin-top:16px;">
      <table class="crud-table compact locaties-table" aria-label="Locaties en adressen">
        <thead>
          <tr>
            <th>Locatie</th>
            <th>Adres</th>
          </tr>
        </thead>
        <tbody>
          {% if location_rows %}
            {% for loc in location_rows %}
              <tr class="{{ loc.row_class }}">
                <td class="wrap">{{ loc.name }}</td>
                <td class="wrap">
                  {% if loc.address %}
                    {{ loc.address }}
                  {% else %}
                    <span class="dash">—</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="2" class="wrap">
                Geen locaties gevonden voor deze week.
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <div style="display:flex; align-items:center; margin-top:20px;">
      <button
        type="button"
        id="syncAgendaBtn"
        class="btn btn-save"
        data-webcal="{{ webcal_url }}"
        data-https="{{ webcal_https_url }}"
        style="margin-left:auto;"
      >
        Synchroniseer met agenda app
      </button>
    </div>

  </div>
</div>

<!-- Modal -->
<div id="agendaModal" class="modal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.6);">
  <div class="modal-content diensten-modal"
       style="background-color:var(--panel); margin:10% auto; padding:25px; border:1px solid var(--border); width:90%; border-radius:12px; max-width:640px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);">

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom: 1px solid var(--border); padding-bottom: 15px;">
      <h2 style="margin:0; font-size: 1.4rem;">Agenda synchronisatie</h2>
      <span id="agendaModalClose" style="cursor:pointer; font-size:28px; font-weight:bold; color:var(--muted); line-height: 1;">&times;</span>
    </div>

    <!-- Desktop variant -->
    <div id="agendaDesktop" style="display:none;">
      <p style="margin-top:0; color:var(--muted);">
        Wil je je diensten in je agenda? Open de Jansen app op je telefoon en klik op de synchroniseer knop. Of kopieer de link hieronder en open die op je telefoon.
        Als je hem één keer toevoegt, worden wijzigingen automatisch bijgewerkt.
      </p>

      <label class="section-label">Jouw agenda-link</label>
      <div style="display:flex; gap:10px; align-items:center;">
        <input id="webcalInput" class="admin-input" type="text" readonly value="{{ webcal_url }}" style="flex:1;">
        <button type="button" id="copyWebcalBtn" class="btn">Kopieer</button>
      </div>

      <div style="margin-top:14px; padding-top:16px; border-top: 1px solid var(--border);">
        <small style="color:var(--muted); display:block; line-height:1.5;">
          <strong>Zo voeg je hem toe op je telefoon:</strong><br>
          1) Open de Jansen app op je telefoon of kopieer de link hierboven.<br>
          2) Stuur de link naar jezelf (WhatsApp of e-mail) en open hem op je telefoon of typ hem over in je browser.<br>
          3) Kies in je agenda-app voor <em>Abonneren</em> / <em>Kalender toevoegen</em> en bevestig.
        </small>
      </div>

      <div style="margin-top:14px;">
        <small style="color:var(--muted); display:block; line-height:1.5;">
          <strong>Lukt openen niet?</strong><br>
          Open je agenda-app en open <em>Instellingen</em>. Klik op <em>Kalender toevoegen</em> (of <em>Abonneren</em>) en plak daar de link.
        </small>
      </div>

      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:18px;">
        <button type="button" id="agendaModalOkDesktop" class="btn btn-danger">Sluiten</button>
      </div>
    </div>

    <!-- Mobile variant -->
    <div id="agendaMobile" style="display:none;">
      <p style="margin-top:0; color:var(--muted);">
        Voeg je diensten toe aan je agenda. Daarna worden wijzigingen automatisch bijgewerkt.
      </p>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:14px;">
        <button type="button" id="openAgendaBtn" class="btn btn-save">Open agenda-app</button>
        <button type="button" id="copyWebcalBtnMobile" class="btn">Kopieer link</button>
      </div>

      <div style="margin-top:18px; padding-top:16px; border-top: 1px solid var(--border);">
        <small style="color:var(--muted); display:block; line-height:1.5;">
          <strong>Werkt de “Open agenda-app” knop niet?</strong><br>
          1) Tik op <em>Kopieer link</em>.<br>
          2) Open je agenda-app en ga naar <em>Instellingen</em>.<br>
          3) Kies <em>Kalender toevoegen</em> of <em>Abonneren</em>.<br>
          4) Plak de link en sla op.
        </small>
      </div>

      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:16px;">
        <button type="button" id="agendaModalOkMobile" class="btn btn-danger">Sluiten</button>
      </div>
    </div>

  </div>
</div>

{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/diensten/diensten.js' %}" defer></script>
{% endblock %}