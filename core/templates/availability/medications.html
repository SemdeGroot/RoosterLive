{% extends "base.html" %}
{% block title %}{{ title }}{% endblock %}
{% block header_title %}{{ title }}{% endblock %}

{% block content %}
<style>
  /* --- Uploader styles (zoals rooster) --- */
  .uploader { margin-bottom: 14px; }
  .dropzone {
    display:flex; align-items:center; gap:12px;
    padding:14px 16px; background:var(--panel-2);
    border:1px dashed var(--border); border-radius:12px; cursor:pointer;
    transition:border-color .15s, box-shadow .15s;
  }
  .dropzone:hover, .dropzone.is-dragover {
    border-color:#1f4ba0;
    box-shadow:0 0 0 2px rgba(31,75,160,.20) inset;
  }
  .dz-icon {
    flex:0 0 auto; width:36px; height:36px; border-radius:10px;
    display:flex; align-items:center; justify-content:center;
    background:#13223f; color:#cfe0ff; border:1px solid #223355;
  }
  .dz-text { display:flex; flex-direction:column; gap:4px; }
  .dz-title { color:var(--text); font-weight:600; line-height:1.1; }
  .dz-hint { color:var(--muted); font-size:.95em; }
  .file-meta { margin-top:8px; color:var(--muted); }
  .file-name { color:var(--text); font-weight:600; }
  .u-actions { display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; align-items:center; }
  .btn.ghost { background:#17212b; }

  /* Zoekveld */
  .search-row {
    display:flex; align-items:center; margin:16px 0 8px; gap:10px;
  }
  .search-row label { min-width:70px; }
  .search-row input {
    flex:1; background:var(--panel-2); border:1px solid var(--border);
    border-radius:8px; color:var(--text); padding:8px 10px; font-size:.95rem;
  }
  .search-row input:focus {
    outline:none; border-color:#1f4ba0; box-shadow:0 0 0 1px #1f4ba0;
  }

  /* Tabel en knop */
  .table-wrap { overflow:auto; }
  table.manage-table { min-width:600px; }
  .table-footer {
    display:flex; justify-content:center; margin-top:10px;
  }
  .toggle-btn {
    background:#17212b;
    border:1px solid var(--border);
    color:var(--text);
    padding:7px 12px;
    border-radius:8px;
    cursor:pointer;
    transition:all .15s;
  }
  .toggle-btn:hover {
    border-color:#1f4ba0;
    box-shadow:0 0 0 2px rgba(31,75,160,.20) inset;
  }
</style>

<div class="card" style="padding:16px;">
  <h3 style="margin-top:0;">Voorraad</h3>

  {% if perms.core.can_upload_voorraad %}
  <form method="post" enctype="multipart/form-data" class="uploader" id="medForm">
    {% csrf_token %}
    <input type="file" id="medFile" name="file" accept=".csv,.xlsx,.xls" hidden required>

    <div class="dropzone" id="medDrop" onclick="document.getElementById('medFile').click()">
      <div class="dz-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <path d="M14 2v6h6"/>
          <path d="M12 12v6"/>
          <path d="M9 15h6"/>
        </svg>
      </div>
      <div class="dz-text">
        <div class="dz-title">Sleep je voorraad bestand hierheen of klik om te kiezen</div>
        <div class="dz-hint">
          Alleen .csv / .xlsx / .xls – Het nieuwe bestand vervangt automatisch het oude <strong>zodra je op Uploaden klikt.</strong>
        </div>
      </div>
    </div>

    <div class="file-meta" id="medMeta" style="display:none;">
      Geselecteerd: <span class="file-name" id="medName"></span>
    </div>

    <div class="u-actions">
      <button class="btn" type="submit" id="medUpload" disabled>Uploaden</button>
      <button type="button" class="btn ghost" id="medClear" style="display:none;">Wissen</button>
    </div>
  </form>
  {% endif %}

  <div class="search-row">
    <label for="medSearch"><strong>Zoeken</strong></label>
    <input id="medSearch" type="text" placeholder="Typ om te zoeken...">
  </div>

  {% if rows %}
    <div class="table-wrap">
      <table class="manage-table" id="medTable">
        <thead>
          <tr>{% for c in columns %}<th>{{ c }}</th>{% endfor %}</tr>
        </thead>
        <tbody>
          {% for r in rows %}
            <tr>{% for cell in r %}<td>{{ cell }}</td>{% endfor %}</tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Knop onderaan -->
    <div class="table-footer">
      <button type="button" class="toggle-btn" id="medToggle" style="display:none;">Toon alles</button>
    </div>

  {% else %}
    <p style="color:var(--muted); margin:8px 0 0;">Nog geen bestand geüpload.</p>
  {% endif %}
</div>

<script>
(function(){
  // --- Dropzone (no-op als elementen ontbreken)
  function wireUpload(inputId, dropId, metaId, nameId, uploadBtnId, clearBtnId){
    const dz = document.getElementById(dropId);
    const input = document.getElementById(inputId);
    const meta = document.getElementById(metaId);
    const nameSpan = document.getElementById(nameId);
    const uploadBtn = document.getElementById(uploadBtnId);
    const clearBtn = document.getElementById(clearBtnId);

    // Als er geen upload UI is (geen rechten), gewoon stoppen
    if (!dz || !input) return;

    function setFile(file){
      if(!file) return;
      const ok = ['.csv','.xlsx','.xls'].some(ext => file.name.toLowerCase().endsWith(ext));
      if(!ok){ alert('Kies een CSV of Excel-bestand.'); return; }
      const dt = new DataTransfer(); dt.items.add(file); input.files = dt.files;
      if (nameSpan) nameSpan.textContent = file.name;
      if (meta) meta.style.display = '';
      if (uploadBtn) uploadBtn.disabled = false;
      if (clearBtn) clearBtn.style.display = '';
    }

    input.addEventListener('change', ()=> setFile(input.files[0]));
    ['dragenter','dragover'].forEach(ev =>
      dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.add('is-dragover'); })
    );
    ['dragleave','drop'].forEach(ev =>
      dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.remove('is-dragover'); })
    );
    dz.addEventListener('drop', e => { const f = e.dataTransfer.files?.[0]; if(f) setFile(f); });
    clearBtn && clearBtn.addEventListener('click', ()=>{
      input.value=''; if (nameSpan) nameSpan.textContent='';
      if (meta) meta.style.display='none';
      if (uploadBtn) uploadBtn.disabled=true;
      clearBtn.style.display='none';
    });
  }

  // Alleen proberen te “wires” als het formulier er is
  if (document.getElementById('medForm')) {
    wireUpload('medFile','medDrop','medMeta','medName','medUpload','medClear');
  }
  if (document.getElementById('nazForm')) {
    wireUpload('nazFile','nazDrop','nazMeta','nazName','nazUpload','nazClear');
  }

  // --- Live zoeken + limiter blijft altijd werken (zonder uploadrechten)
  function enableLiveSearch(tableId, inputId, toggleId){
    const DEFAULT_LIMIT = 20;
    const table = document.getElementById(tableId);
    const q = document.getElementById(inputId);
    const toggleBtn = document.getElementById(toggleId);
    if (!table || !q) return;

    let showAll = false;
    function applyFilter(){
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const needle = (q.value || '').trim().toLowerCase();
      const matched = [];

      rows.forEach(tr=>{
        const ok = tr.textContent.toLowerCase().includes(needle);
        tr.style.display = 'none';
        if (ok) matched.push(tr);
      });

      const limit = showAll ? matched.length : DEFAULT_LIMIT;
      matched.slice(0, limit).forEach(tr => tr.style.display = '');
      if (toggleBtn){
        toggleBtn.style.display = matched.length > DEFAULT_LIMIT ? '' : 'none';
        toggleBtn.textContent = showAll ? 'Toon eerste 20' : 'Toon alles';
      }
    }

    q.addEventListener('input', ()=>{ showAll = false; applyFilter(); });
    toggleBtn && toggleBtn.addEventListener('click', ()=>{ showAll = !showAll; applyFilter(); });
    applyFilter();
  }

  // Voorraad
  enableLiveSearch('medTable','medSearch','medToggle');
})();
</script>
{% endblock %}