{% extends "base.html" %}
{% block title %}Nieuws{% endblock %}
{% block header_title %}Nieuws{% endblock %}

{% block content %}
<style>
/* Uploader */
.uploader { margin-bottom: 14px; }
.dropzone {
  display:flex; align-items:center; gap:12px; padding:14px 16px;
  background:var(--panel-2); border:1px dashed var(--border); border-radius:12px;
  cursor:pointer; transition:border-color .15s, box-shadow .15s;
}
.dropzone:hover, .dropzone.is-dragover { border-color:#072a72; }
.dz-icon { flex:0 0 auto; width:36px; height:36px; border-radius:10px; display:flex; align-items:center; justify-content:center; background:#13223f; color:#cfe0ff; border:1px solid #223355; }
.dz-text { display:flex; flex-direction:column; gap:4px; }
.dz-title { color:var(--text); font-weight:600; line-height:1.1; }
.dz-hint  { color:var(--muted); font-size:.95em; }
.file-meta { margin-top:8px; color:var(--muted); }
.file-name { color:var(--text); font-weight:600; }
.u-actions { display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
.btn.ghost { background:#17212b; }

/* Weergave */
.pages{
  display:flex;
  flex-direction:column;
  gap:16px;
  align-items:stretch;
  width:100%;
}

.page{
  position: relative;
  background:linear-gradient(180deg,var(--panel),var(--panel-2));
  border:1px solid var(--border);
  border-radius:16px;
  box-shadow:0 8px 24px var(--shadow);
  width:100%;
  max-width:100%;
  overflow:hidden;
  padding:0;
}

.page img{
  display:block;
  width:100%;
  height:auto;
  object-fit:cover;
  border-radius:0;
  position: relative;
  z-index:1;
}

/* Verwijder-knop */
.del-btn {
  position:absolute; top:10px; right:10px;
  z-index:2;
  background:#2a3647; border:1px solid #3a4b63; color:#fff;
  border-radius:10px; padding:6px 10px; cursor:pointer; opacity:.92;
}
.del-btn:hover { background:#3a4b63; opacity:1; }
.del-btn[disabled]{opacity:.5; cursor:not-allowed}

/* Footer met "Toon meer" */
.pages-footer{
  display:flex;
  justify-content:center;
  margin-top:12px;
}
.more-btn{
  background:#17212b;
  border:1px solid var(--border);
  color:var(--text);
  padding:7px 12px;
  border-radius:8px;
  cursor:pointer;
  transition:all .15s;
}
.more-btn:hover{ background:#1f2d3d; border-color:#072a72; }
</style>

<div class="card" style="padding:16px;">

  {% if perms.core.can_upload_news %}
  <form method="post" enctype="multipart/form-data" class="uploader" id="newsForm">
    {% csrf_token %}
    <input type="file" id="newsFile" name="file" accept="application/pdf" hidden required>

    <div class="dropzone" id="newsDrop" onclick="document.getElementById('newsFile').click()">
      <div class="dz-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <path d="M14 2v6h6"/>
          <path d="M12 12v6"/>
          <path d="M9 15h6"/>
        </svg>
      </div>
      <div class="dz-text">
        <div class="dz-title">Sleep je PDF met nieuws hierheen of klik om te kiezen.</div>
        <div class="dz-hint">
          Alleen .pdf — Nieuwe uploads worden toegevoegd (vorige blijven staan) <strong>zodra je op Uploaden klikt.</strong><br>
          <em>Nieuws wordt automatisch verwijderd na 6 maanden.</em>
        </div>
      </div>
    </div>

    <div class="file-meta" id="newsMeta" style="display:none;">
      Geselecteerd: <span class="file-name" id="newsName"></span>
    </div>

    <div class="u-actions">
      <button class="btn" type="submit" id="newsUpload" disabled>Uploaden</button>
      <button type="button" class="btn ghost" id="newsClear" style="display:none;">Wissen</button>
    </div>
  </form>
  {% endif %}

  {% if not page_urls %}
    <p style="color:var(--muted); margin-top:6px;">Nog geen nieuws geüpload.</p>
  {% else %}
    <div class="pages" id="newsPages">
      {% for url in page_urls %}
        <div class="page" data-img="{{ url }}">
          {% if perms.core.can_upload_news %}
            <button class="del-btn" type="button" title="Upload verwijderen" data-img="{{ url }}">✕</button>
          {% endif %}
          <img src="{{ url }}" alt="Nieuws pagina">
        </div>
      {% endfor %}
    </div>

    <!-- "Toon meer" knop onder de lijst -->
    <div class="pages-footer">
      <button type="button" class="more-btn" id="newsMore" style="display:none;">Toon meer</button>
    </div>
  {% endif %}
</div>

<script>
(function(){
  // --- Upload UI
  const dz=document.getElementById('newsDrop'),
        input=document.getElementById('newsFile'),
        meta=document.getElementById('newsMeta'),
        nameSpan=document.getElementById('newsName'),
        uploadBtn=document.getElementById('newsUpload'),
        clearBtn=document.getElementById('newsClear');

  if(dz && input){
    function setFile(file){
      if(!file) return;
      if(file.type!=='application/pdf' && !file.name.toLowerCase().endsWith('.pdf')){
        alert('Kies een PDF (.pdf).'); return;
      }
      const dt=new DataTransfer(); dt.items.add(file); input.files=dt.files;
      if(nameSpan) nameSpan.textContent=file.name;
      if(meta) meta.style.display='';
      if(uploadBtn) uploadBtn.disabled=false;
      if(clearBtn) clearBtn.style.display='';
    }
    input.addEventListener('change', ()=> setFile(input.files[0]));
    ['dragenter','dragover'].forEach(ev=>dz && dz.addEventListener(ev, e=>{e.preventDefault(); dz.classList.add('is-dragover');}));
    ['dragleave','drop'].forEach(ev=>dz && dz.addEventListener(ev, e=>{e.preventDefault(); dz.classList.remove('is-dragover');}));
    dz && dz.addEventListener('drop', e=>{const f=e.dataTransfer.files?.[0]; if(f) setFile(f);});
    clearBtn && clearBtn.addEventListener('click', ()=>{
      input.value=''; if(nameSpan) nameSpan.textContent='';
      if(meta) meta.style.display='none';
      if(uploadBtn) uploadBtn.disabled=true;
      clearBtn.style.display='none';
    });
  }

  // --- "Toon meer" voor PNG's
  const pages = document.getElementById('newsPages');
  const moreBtn = document.getElementById('newsMore');
  const STEP = 10;
  let currentLimit = STEP;

  function applyLimit(){
    if(!pages) return;
    const cards = Array.from(pages.children); // .page elementen
    const total = cards.length;

    // Zorgt dat alleen de eerste currentLimit zichtbaar zijn
    cards.forEach((el, idx) => {
      el.style.display = (idx < currentLimit) ? '' : 'none';
    });

    // Knop tonen als er nog meer te laten zien is
    if(moreBtn){
      if(total > currentLimit){
        moreBtn.style.display = '';
        moreBtn.disabled = false;
        moreBtn.textContent = 'Toon meer';
      } else {
        moreBtn.style.display = 'none';
      }
    }
  }

  // Init na pagina-load
  if(pages){
    applyLimit();
  }

  // Elke klik toont 10 extra PNG's
  moreBtn && moreBtn.addEventListener('click', () => {
    currentLimit += STEP;
    applyLimit();
  });

  // --- Inline delete via fetch naar DEZELFDE URL
  if(pages){
    function getCSRF(){
      const m=document.cookie.match(/csrftoken=([^;]+)/); return m?m[1]:"";
    }
    pages.addEventListener('click', async (e)=>{
      const btn = e.target.closest('.del-btn');
      if(!btn) return;
      const img = btn.getAttribute('data-img');
      if(!img) return;
      if(!confirm('Weet je zeker dat je de PDF wilt verwijderen?')) return;
      btn.disabled = true;

      try{
        const resp = await fetch(window.location.href, {
          method: "POST",
          headers: {
            "X-CSRFToken": getCSRF(),
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: "action=delete&img=" + encodeURIComponent(img)
        });
        const data = await resp.json();
        if(data && data.ok){
          // Verwijder alle tegels die tot dezelfde hash behoren (server geeft hash terug)
          const hash = data.hash;
          document.querySelectorAll('.page').forEach(card=>{
            const u = card.getAttribute('data-img') || '';
            if(u.includes('/cache/news/'+hash+'/')) card.remove();
          });
          // Herbereken zichtbaarheid/knop na verwijderen
          applyLimit();
        }else{
          alert(data && data.error ? data.error : "Verwijderen mislukt.");
          btn.disabled = false;
        }
      }catch(err){
        alert("Netwerkfout bij verwijderen.");
        btn.disabled = false;
      }
    });
  }
})();
</script>
{% endblock %}