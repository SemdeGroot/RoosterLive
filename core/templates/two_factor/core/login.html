{% extends "two_factor/_base.html" %}
{% load i18n static %}

{% block login_header_image %}
  {% load static %}
  {% if form.otp_token or form.token %}
    <div class="twofa-image-wrap">
        <span
          class="birthday-icon icon-badge i-aqua"
          style="--icon: url('{% static 'img/lucide/twofactor-lucide.svg' %}');"
          aria-hidden="true">
        </span>
    </div>
  {% else %}
    <div class="logo-wrap-login default-logo">
      {% static 'img/logo.jpg' as static_logo %}
      <img class="logo-login" src="{% firstof logo_url static_logo %}" alt="Apotheek Jansen">
    </div>
  {% endif %}
{% endblock %}

{% block content %}
<noscript>
  <style>
    #passwordBlock { display: block !important; }
    #passkeyStatus { display: none !important; }
    #passkeyLoginError { display: none !important; }
  </style>
</noscript>

  <form method="post" autocomplete="off" novalidate>
    {% csrf_token %}
    {{ wizard.management_form }}
    <input type="hidden" name="is_capacitor" id="is_capacitor" value="0">
    <input type="hidden" name="biometric_capable" id="biometric_capable" value="0">
    <input type="hidden" name="biometric_secret_present" id="biometric_secret_present" value="0">

    {# STAP 1: username + password #}
    {% if form.username and form.password %}
        <p class="password-logintext">
        Vul je voornaam of e-mailadres in (als je voornaam niet uniek is). Bevestig daarna met je passkey. Lukt dat niet, gebruik dan je wachtwoord en 2FA-code.
      </p>
      <label class="section-label" for="{{ form.username.id_for_label }}">Voornaam of E-mail</label>
      {{ form.username }}

      <div id="passwordBlock" style="display:none;">
        <label class="section-label" for="{{ form.password.id_for_label }}">Wachtwoord</label>
        {{ form.password }}
      </div>

      <button class="btn btn-save" type="submit" style="padding: 12px;" data-haptic>{% trans "Inloggen" %}</button>

      {# --- Kiosk inlog --- #}
    {% if show_kiosk_login %}
        <button type="submit" 
                form="kiosk_form" 
                class="btn" 
                style="padding: 12px;" >
          {% trans "Log in met het standaardaccount" %}
        </button>
    {% endif %}

      <!-- Passkey status message (geen ruimte totdat JS 'm toont) -->
      <p id="passkeyStatus"
         class="passkey-message"
         aria-live="polite"
         aria-atomic="true"></p>

      <p id="passkeyLoginError"
        class="passkey-message error"
        style="display:none;"
        aria-live="polite"
        aria-atomic="true"></p>

      <p class="forgot-password forgot-password--left">
        <a href="{% url 'password_reset' %}">Wachtwoord vergeten?</a>
      </p>

      <p class="forgot-password forgot-password--right">
        <a href="#" data-action="email"
          onclick="openContactModal(this.dataset.action); return false;">
          E-mail opnieuw instellen?
        </a>
      </p>

    {# STAP 2: TOTP code (veldnaam kan otp_token of token heten) #}
    {% elif form.otp_token or form.token %}
      <h1 style="text-align:center;">{% trans "Voer je 2FA-code in" %}</h1>
      <p class="twofa-logintext muted">
        Open je authenticator app en vul de 6-cijferige code in.
      </p>

      {% if form.otp_token %}
        <label class="section-label" for="{{ form.otp_token.id_for_label }}">6-cijferige code</label>
        {{ form.otp_token }}
      {% else %}
        <label class="section-label" for="{{ form.token.id_for_label }}">6-cijferige code</label>
        {{ form.token }}
      {% endif %}

      <button class="btn btn-save" type="submit" style="padding: 12px;" data-haptic>{% trans "Bevestigen" %}</button>

      <p class="forgot-password forgot-password--center">
        <a href="#" data-action="2fa"
          onclick="openContactModal(this.dataset.action); return false;">
          2FA opnieuw instellen?
        </a>
      </p>

    {% endif %}

    <div id="contactModal" class="contact-modal">
      <div class="contact-modal-content">
        <div class="contact-header">
          <h3>Contacteer beheer</h3>
          <span class="contact-close" onclick="closeContactModal()" aria-label="Sluiten">
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path d="M18 6L6 18M6 6l12 12" />
            </svg>
          </span>
        </div>
        <p id="contactModalBody"></p>
      </div>
    </div>
  </form>

  {% if show_kiosk_login %}
  {# Dit formulier wordt getriggerd door de knop hierboven #}
  <form id="kiosk_form" method="post" action="{% url 'kiosk_login' %}">
    {% csrf_token %}
  </form>
  {% endif %}

{% endblock %}
