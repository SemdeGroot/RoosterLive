{% extends "base.html" %}
{% load static %}
{% load tz %}
{% load form_extras %}

{% block title %}Review historie{% endblock %}
{% block header_title %}Review historie{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{% static 'css/base/table.css' %}">
  <link rel="stylesheet" href="{% static 'css/medicatiebeoordeling/medicatiebeoordeling.css' %}">
  <link rel="stylesheet" href="{% static 'css/agenda/agenda.css' %}">

  <script src="{% static 'js/base/table.js' %}" defer></script>
  <script src="{% static 'js/medicatiebeoordeling/medicatiebeoordeling.js' %}" defer></script>
{% endblock %}

{% block content %}
<div class="card birthdays-card">
  <div class="agenda-section">

    <div class="birthday-header agenda-section-header">
    <span
      class="birthday-icon icon-badge i-slate"
      style="--icon: url('{% static 'img/lucide/historie-lucide.svg' %}');"
      aria-hidden="true">
    </span>
      <div class="birthday-header-text">
        <h2>Medicatiebeoordeling Historie</h2>
        <p>Zoek door afdelingen of specifieke patiënten.</p>
      </div>
        <a href="{% url 'medicatiebeoordeling_tiles' %}" class="btn">
          Terug naar Medicatiebeoordeling
        </a>
      <a href="{% url 'medicatiebeoordeling_create' %}" class="btn btn-save">Nieuwe Analyse</a>
    </div>

    <h3 class="jansen-title" style="margin-top:20px;">Afdelingen</h3>

    <div class="search-container" style="display:flex; gap:10px;">
      <input type="text" id="searchAfdelingInput" class="search-input" placeholder="Zoek afdeling en klik op enter...">
      <button id="btnSearchAfdeling" class="btn">Zoek</button>
    </div>

    {# data-crud wrapper voor pagination + sort #}
    <div data-crud data-table="#afdelingTable" data-rows="#tbodyAfdeling tr" data-page-size="10">
      <div class="table-scroll">
        <table class="crud-table med-table table-afdeling-history" id="afdelingTable">
          <thead>
            <tr>
              <th>Afdeling</th>
              <th>Locatie</th>
              <th>Zorginstelling</th>
              <th data-sort="date">Gewijzigd</th>
              <th>Door</th>
              <th data-nosort>Actie</th>
            </tr>
          </thead>
          <tbody id="tbodyAfdeling">
            {% for afd in afdelingen_page %}
              <tr>
                <td>
                  <a href="{% url 'medicatiebeoordeling_afdeling_detail' afd.pk %}"
                     style="font-weight:bold; color:var(--text); text-decoration:none;">
                    {{ afd.afdeling }}
                  </a>
                </td>

                <td>{{ afd.locatie }}</td>
                <td style="color:var(--muted);">{{ afd.organisatie.name }}</td>
                <td>
                  {% if afd.updated_at %}
                    {{ afd.updated_at|date:"d-m-Y H:i" }}
                  {% else %}
                    {{ afd.created_at|date:"d-m-Y H:i" }}
                  {% endif %}
                </td>
                <td>
                  {% if afd.updated_by %}
                    {{ afd.updated_by|dutch_name }}
                  {% else %}
                    {{ afd.created_by|dutch_name }}
                  {% endif %}
                </td>
                <td>
                  <div style="display:flex; gap:6px;">
                    <a href="{% url 'medicatiebeoordeling_afdeling_detail' afd.pk %}"
                       class="btn btn-save"
                       style="padding:6px 10px; font-size:0.85rem;">
                      Bekijk
                    </a>

                    <form method="post"
                          action="{% url 'medicatiebeoordeling_clear_afdeling' afd.pk %}"
                          onsubmit="return confirm('Weet je zeker dat je de review van {{ afd.afdeling }} wilt wissen? De afdeling zelf blijft in het systeem.');"
                          style="margin:0;">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-danger" style="padding:6px; min-width:auto;" title="Review wissen (Afdeling behouden)">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="3 6 5 6 21 6"/>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                          <line x1="10" y1="11" x2="10" y2="17"/>
                          <line x1="14" y1="11" x2="14" y2="17"/>
                        </svg>
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="6" style="text-align:center; color:grey;">Geen actieve reviews gevonden.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {# Gebruik dezelfde knop (id blijft), maar voeg data-crud-more toe #}
      <div id="btnContainerAfdeling"
           class="crud-more-wrap"
           style="text-align:center; margin-bottom:40px;"
           {% if not afdelingen_page.has_next %}hidden{% endif %}>
        <button id="btnMoreAfdeling" class="btn" type="button" data-crud-more>
          Toon meer
        </button>
      </div>
    </div>

    <h3 class="jansen-title">Patiënten</h3>

    <div class="search-container" style="display:flex; gap:10px;">
      <input type="text" id="searchPatientInput" class="search-input" placeholder="Zoek patiënt op naam of geboortedatum en klik op enter...">
      <button id="btnSearchPatient" class="btn">Zoek</button>
    </div>

    <div data-crud data-table="#patientTable" data-rows="#tbodyPatient tr" data-page-size="10">
      <div class="table-scroll">
        <table class="crud-table med-table table-patient-history" id="patientTable">
          <thead>
            <tr>
              <th>Naam</th>
              <th data-sort="date">Geb. Datum</th>
              <th>Afdeling</th>
              <th>Locatie</th>
              <th>Zorginstelling</th>
              <th data-sort="date">Gewijzigd</th>
              <th>Door</th>
              <th data-nosort>Actie</th>
            </tr>
          </thead>

          <tbody id="tbodyPatient">
            {% for pat in patienten_page %}
              <tr>
                <td>
                  <a href="{% url 'medicatiebeoordeling_patient_detail' pat.pk %}"
                     style="font-weight:bold; color:var(--text); text-decoration:none;">
                    {{ pat.naam }}
                  </a>
                </td>

                <td>{{ pat.geboortedatum|date:"d-m-Y"|default:"-" }}</td>
                <td style="color:var(--muted);">{{ pat.afdeling.afdeling }}</td>
                <td style="color:var(--muted);">{{ pat.afdeling.locatie }}</td>
                <td style="color:var(--muted);">{{ pat.afdeling.organisatie.name }}</td>

                <td>
                  {% if pat.updated_at %}
                    {{ pat.updated_at|date:"d-m-Y H:i" }}
                  {% else %}
                    {{ pat.created_at|date:"d-m-Y H:i" }}
                  {% endif %}
                </td>

                <td>
                  {% if pat.updated_by %}
                    {{ pat.updated_by|dutch_name }}
                  {% else %}
                    {{ pat.created_by|dutch_name }}
                  {% endif %}
                </td>

                <td>
                  <div style="display:flex; gap:6px;">
                    <a href="{% url 'medicatiebeoordeling_patient_detail' pat.pk %}"
                       class="btn btn-save"
                       style="padding:6px 10px; font-size:0.85rem;">
                      Bekijk
                    </a>

                    <form method="post"
                          action="{% url 'medicatiebeoordeling_delete_patient' pat.pk %}"
                          onsubmit="return confirm('Weet je zeker dat je patiënt {{ pat.naam }} wilt verwijderen?');"
                          style="margin:0;">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-danger" style="padding:6px; min-width:auto;" title="Patiënt verwijderen">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="3 6 5 6 21 6"/>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                          <line x1="10" y1="11" x2="10" y2="17"/>
                          <line x1="14" y1="11" x2="14" y2="17"/>
                        </svg>
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="8" style="text-align:center; color:grey;">Geen patiënten gevonden.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div id="btnContainerPatient"
           class="crud-more-wrap"
           style="text-align:center; margin-top:20px; margin-bottom:2px;"
           {% if not patienten_page.has_next %}hidden{% endif %}>
        <button id="btnMorePatient" class="btn" type="button" data-crud-more>
          Toon meer
        </button>
      </div>
    </div>

  </div>
</div>
{% endblock %}
