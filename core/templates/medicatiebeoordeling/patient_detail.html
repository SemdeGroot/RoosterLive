{% extends "base.html" %}
{% load static form_extras %}

{% block title %}{{ patient.naam }}{% endblock %}
{% block header_title %}Pati√´nt Analyse{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{% static 'css/agenda/agenda.css' %}">
    <link rel="stylesheet" href="{% static 'css/medicatiebeoordeling/medicatiebeoordeling.css' %}">
{% endblock %}

{% block content %}
<div class="review-card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
            <h2 style="margin:0;">{{ patient.naam }} <small style="color:var(--muted); font-size:0.6em;">({{ patient.leeftijd|default:"?" }} jr)</small></h2>
            <p style="margin:4px 0 0 0; color:var(--muted);">Afdeling: {{ afdeling.afdeling }}</p>
        </div>
        <a href="{% url 'medicatiebeoordeling_afdeling_detail' afdeling.pk %}" class="btn" style="background:var(--panel-2);">‚Üê Terug</a>
    </div>
</div>

<div class="review-card">
    <h3 style="margin-top:0; margin-bottom:16px;">Analyses</h3>
    
    <div class="analysis-section">
        <div class="analysis-header">üõë STOPP Criteria</div>
        <div class="analysis-body">
            {% if analysis.analyses.stopp %}
                <div class="alert-box alert-stopp">
                    <strong>‚ö†Ô∏è {{ analysis.analyses.stopp|length }} criteria gevonden:</strong>
                    <ul style="padding-left:20px; margin:8px 0 0;">
                        {% for item in analysis.analyses.stopp %}
                            <li style="margin-bottom:6px;">
                                {{ item.description }}<br>
                                <small style="opacity:0.8;"><em>Door: {{ item.triggering_medicines }}</em></small>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% else %}
                <div class="alert-box alert-safe">‚úÖ Geen STOPP-criteria gevonden.</div>
            {% endif %}
        </div>
    </div>

    <div class="analysis-section">
        <div class="analysis-header">üß† Anticholinerge Belasting (ACB)</div>
        <div class="analysis-body">
            {% if analysis.analyses.acb.score > 0 %}
                <div class="alert-box alert-acb">
                    <strong>Score: {{ analysis.analyses.acb.score }}</strong> ‚Äî {{ analysis.analyses.acb.interpretatie }}
                    {% if analysis.analyses.acb.details %}
                        <ul style="padding-left:20px; margin:8px 0 0;">
                            {% for detail in analysis.analyses.acb.details %}
                                <li>{{ detail.middel }} (Score: {{ detail.score }})</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
            {% else %}
                <div class="alert-box alert-safe">‚úÖ Score 0 (Geen belasting)</div>
            {% endif %}
        </div>
    </div>

    {% if analysis.analyses.dubbelmedicatie %}
    <div class="analysis-section">
        <div class="analysis-header">üëØ Dubbelmedicatie</div>
        <div class="analysis-body">
            <div class="alert-box alert-dubbel">
                <strong>‚ö†Ô∏è Mogelijke dubbelmedicatie gevonden:</strong>
                <ul style="padding-left:20px; margin:8px 0 0;">
                    {% for item in analysis.analyses.dubbelmedicatie %}
                        <li style="margin-bottom:6px;">
                            <strong>{{ item.groep }}</strong>: 
                            <span style="opacity:0.9;">{{ item.middelen|join:", " }}</span>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    {% endif %}

</div>

<form method="post">
    {% csrf_token %}
    <div class="review-card">
        <div style="border-bottom:1px solid var(--border); padding-bottom:16px; margin-bottom:16px; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0;">Medicatieoverzicht & Opmerkingen</h3>
            <button type="submit" class="btn btn-primary" style="background:var(--accent); border-color:var(--accent);">
                üíæ Opslaan
            </button>
        </div>

        <div style="display:flex; flex-direction:column; gap:24px;">
            {% for group_id, group_data in grouped_meds %}
                <div class="med-group">
                    
                    <h4 style="color:var(--accent); margin:0 0 10px 0; font-size:1.1rem;">
                        {{ group_data.naam }}
                    </h4>

                    <table class="med-table">
                        <thead>
                            <tr>
                                <th style="width:30%">Middel</th>
                                <th style="width:20%">Gebruik</th>
                                <th style="width:50%">Opmerking (Medimo)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for gm in group_data.meds %}
                            <tr>
                                <td><strong style="color:var(--text);">{{ gm.clean }}</strong></td>
                                <td>{{ gm.gebruik }}</td>
                                <td style="color:var(--muted); font-size:0.9em;">{{ gm.opmerking|default:"-" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <div style="margin-top:8px;">
                        <label for="comment_{{ group_id }}" style="font-size:0.9rem; color:var(--muted); margin-bottom:4px; display:block;">
                            Opmerking apotheker:
                        </label>
                        <textarea 
                            name="comment_{{ group_id }}" 
                            id="comment_{{ group_id }}"
                            class="med-comment-box" 
                            placeholder="Typ hier uw bevindingen..."
                        >{{ comments_lookup|get_item:group_id }}</textarea>
                    </div>
                </div>
            {% endfor %}
        </div>
        
        <div style="margin-top:24px; text-align:right;">
             <button type="submit" class="btn btn-primary" style="background:var(--accent); border-color:var(--accent);">
                üíæ Opslaan & Bijwerken
            </button>
        </div>
    </div>
</form>
{% endblock %}