{% extends "base.html" %}
{% load static %}

{% block title %}STS Halfjes{% endblock %}
{% block header_title %}STS Halfjes{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{% static 'css/base/table.css' %}">
  <link rel="stylesheet" href="{% static 'css/stshalfjes/stshalfjes.css' %}">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'css/base/select2_dropdown.css' %}">
  <script src="{% static 'js/base/table.js' %}" defer></script>
{% endblock %}

{% block content %}
<div class="card card-inner">
  <div class="agenda-section">
    <div class="birthday-header agenda-section-header">
      <img src="{% static 'img/sts_halfjes.svg' %}" alt="" class="birthday-icon">
      <div class="birthday-header-text">
        <h2>STS Halfjes</h2>
        <p>Meld hier geneesmiddelen die onnodig gehalveerd worden bij de STS afdeling.</p>
      </div>

      {% if can_edit %}
      <div class="header-actions">
        <button type="button" class="btn btn-save" onclick="toggleAddSection()">Toevoegen</button>
      </div>
      {% endif %}
    </div>

    <div class="card-inner" style="padding-top:0;">
      
      {% if can_edit %}
      <div id="addSection" style="display:none;" class="add-section-panel">
        <form method="post" autocomplete="off">
          {% csrf_token %}
          <input type="hidden" name="btn_add" value="1">
          
          <div class="stshalfjes-edit-grid" style="margin-bottom: 15px;">
            <div>
              <label class="select2-label">Item dat gehalveerd wordt</label>
              {{ form.item_gehalveerd }}
            </div>
            <div>
              <label class="select2-label">Alternatief (lagere sterkte)</label>
              {{ form.item_alternatief }}
            </div>
          </div>

          <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button type="button" class="btn btn-danger" onclick="toggleAddSection()">Annuleren</button>
            <button type="submit" class="btn btn-save">Opslaan</button>
          </div>
        </form>
      </div>
      {% endif %}

      <div class="search-bar">
        <input type="text" id="stsSearch" placeholder="Zoek op naam of ZI-nummer..." class="admin-input">
      </div>

      <div data-crud data-table="#stsTable" data-rows=".sts-row" data-page-size="10">
        <div class="table-scroll">
          <table class="crud-table stshalfjes-table" id="stsTable">
            <thead>
              <tr>
                <th class="center-col"></th>
                <th>Wordt gehalveerd</th>
                <th>Alternatief beschikbaar</th>
                <th>Acties</th>
              </tr>
            </thead>
            <tbody>
              {% for item in items %}
              <tr class="sts-row" id="row-{{ item.id }}">
                <td class="center-col" style="color:var(--muted);">{{ forloop.counter }}</td>
                <td class="wrap">
                  <strong>{{ item.item_gehalveerd.naam }}</strong><br>
                  <small>ZI-nummer: {{ item.item_gehalveerd.zi_nummer }}</small>
                </td>
                <td class="wrap" style="color: var(--success-color);">
                  <strong>{{ item.item_alternatief.naam }}</strong><br>
                  <small>ZI-nummer: {{ item.item_alternatief.zi_nummer }}</small>
                </td>
                <td>
                  {% if can_edit %}
                  <div class="actions-wrap horizontal">
                    <button type="button" class="icon-btn" onclick="toggleEdit('{{ item.id }}')">
                      <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
                    </button>
                    <form method="post" class="delete-confirm-form" style="display:inline;">
                      {% csrf_token %}
                      <input type="hidden" name="btn_delete" value="1">
                      <input type="hidden" name="item_id" value="{{ item.id }}">
                      <button class="icon-btn danger" type="submit">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                      </button>
                    </form>
                  </div>
                  {% endif %}
                </td>
              </tr>

              {% if can_edit %}
              <tr id="edit-row-{{ item.id }}" style="display:none;">
                <td colspan="4">
                  <form method="post" class="edit-wrap">
                    {% csrf_token %}
                    <input type="hidden" name="btn_edit" value="1">
                    <input type="hidden" name="item_id" value="{{ item.id }}">
                    <div class="stshalfjes-edit-grid">
                      <div>
                        <label class="section-label">Huidig (halveren):</label>
                        <select name="item_gehalveerd" class="select2-edit">
                          <option value="{{ item.item_gehalveerd.zi_nummer }}" selected>
                            {{ item.item_gehalveerd.naam }}
                          </option>
                        </select>
                      </div>
                      <div>
                        <label class="section-label">Alternatief:</label>
                        <select name="item_alternatief" class="select2-edit">
                          <option value="{{ item.item_alternatief.zi_nummer }}" selected>
                            {{ item.item_alternatief.naam }}
                          </option>
                        </select>
                      </div>
                    </div>
                    <div class="actions-wrap horizontal" style="margin-top:10px;">
                      <button type="button" class="btn btn-danger" onclick="toggleEdit('{{ item.id }}')">Annuleren</button>
                      <button type="submit" class="btn btn-save">Opslaan</button>
                    </div>
                  </form>
                </td>
              </tr>
              {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="{% static 'js/nazendingen/nazendingen.js' %}"></script>
<script src="{% static 'js/base/confirm_delete.js' %}"></script>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    liveSearch("stsSearch", "stsTable", "sts-row");
    
    // Initialiseer AJAX Select2 voor de add-sectie (identiek aan laatstepotten)
    initSelect2($('#id_item_gehalveerd'));
    initSelect2($('#id_item_alternatief'));
  });

  // Toggle logica identiek aan laatstepotten
  function toggleEdit(id) {
    const viewRow = document.getElementById('row-' + id);
    const editRow = document.getElementById('edit-row-' + id);

    if (!viewRow || !editRow) return;

    if (editRow.style.display === 'none') {
      viewRow.style.display = 'none';
      editRow.style.display = 'table-row';

      const $selects = $(editRow).find('.select2-edit');
      $selects.each(function() {
        if (!$(this).hasClass("select2-hidden-accessible")) {
          initSelect2($(this), $('body')); 
        }
      });
    } else {
      viewRow.style.display = 'table-row';
      editRow.style.display = 'none';
      $(editRow).find('.select2-edit').select2('close');
    }
  }

  function toggleAddSection() {
    const section = document.getElementById('addSection');
    if (!section) return;
    section.style.display = (section.style.display === 'none') ? 'block' : 'none';
  }
</script>
{% endblock %}