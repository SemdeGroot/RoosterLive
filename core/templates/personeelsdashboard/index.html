{% extends "base.html" %}
{% load static i18n %}

{% block title %}Teamdashboard{% endblock %}
{% block header_title %}Teamdashboard{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{% static 'css/personeelsdashboard/personeelsdashboard.css' %}">
  <link rel="stylesheet" href="{% static 'css/base/table.css' %}">
{% endblock %}

{% block content %}

<div class="admin-wrap personeelsdashboard-wrap">

  <!-- Top card: controls -->
  <div class="card">
    <div class="card-inner">

      <div class="pd-controlbar">

        <div class="pd-daypicker">
          <label for="dayPicker" class="section-label">Selecteer Dag:</label>
          <select id="dayPicker" class="admin-select pd-select" aria-label="Selecteer dag">
            {% for opt in day_options %}
              <option value="{{ opt.idx }}" {% if opt.idx == selected_day_idx %}selected{% endif %}>
                {{ opt.weekday_label }} ({{ opt.date|date:"d-m" }})
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="pd-weekcenter">
          <div class="week-wrap">
            <div class="week-controls">
              <button id="prevWeekBtn"
                      class="btn btn-icon"
                      {% if not has_prev %}disabled aria-disabled="true"{% endif %}
                      data-target="{{ prev_monday|date:'Y-m-d' }}"
                      aria-label="Vorige week">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                     viewBox="0 0 24 24" fill="none" stroke="currentColor"
                     stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                     class="lucide lucide-arrow-left">
                  <path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>
                </svg>
              </button>

              <div class="week-picker">
                <button id="weekPickerBtn"
                        class="btn week-picker-btn"
                        aria-haspopup="listbox"
                        aria-expanded="false"
                        aria-controls="weekMenu">
                  <span class="wp-label">{{ header_title }}</span>
                  <span class="wp-caret" aria-hidden="true">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                         viewBox="0 0 24 24" fill="none" stroke="currentColor"
                         stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                         class="lucide lucide-chevron-down">
                      <polyline points="6 9 12 15 18 9"/>
                    </svg>
                  </span>
                </button>

                <div id="weekMenu" class="week-menu" role="listbox" tabindex="-1" hidden>
                  {% for opt in week_options %}
                    <div role="option"
                         class="week-option{% if opt.value == monday|date:'Y-m-d' %} is-active{% endif %}"
                         data-value="{{ opt.value }}"
                         aria-selected="{% if opt.value == monday|date:'Y-m-d' %}true{% else %}false{% endif %}">
                      <strong>Week {{ opt.iso_week }} – {{ opt.iso_year }}</strong>
                      <small>({{ opt.start|date:"d-m" }} – {{ opt.end|date:"d-m" }})</small>
                    </div>
                  {% endfor %}
                </div>
              </div>

              <button id="nextWeekBtn"
                      class="btn btn-icon"
                      {% if not has_next %}disabled aria-disabled="true"{% endif %}
                      data-target="{{ next_monday|date:'Y-m-d' }}"
                      aria-label="Volgende week">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                     viewBox="0 0 24 24" fill="none" stroke="currentColor"
                     stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                     class="lucide lucide-arrow-right">
                  <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
                </svg>
              </button>
            </div>

            <div class="availability-daterange">
              {{ monday|date:"d-m-Y" }} – {{ week_end|date:"d-m-Y" }}
            </div>
          </div>
        </div>

        <div class="pd-right-spacer" aria-hidden="true"></div>

      </div>

    </div>
  </div>

  {{ pd_data|json_script:"pd-data" }}

  <div class="pd-main-grid">

    <!-- Links: grid -->
    <div class="card">
      <div class="card-inner">

        <div class="pd-left-header">
          <div>
            <h3 style="margin:0;">Overzicht – {{ selected_day_ctx.weekday_label }}</h3>
            <p class="pd-subtitle" style="margin:4px 0 0 0;">
              Sorteer door op de dagdelen te klikken.
            </p>
          </div>
        </div>

        <hr class="crud-divider">

        <div class="search-bar">
          <input type="text"
                 id="userSearch"
                 placeholder="Zoek op groep of naam…"
                 class="admin-input">
        </div>

        <div class="matrix-wrap">
          <table class="matrix" id="matrixTable" aria-label="Beschikbaarheid per medewerker en dagdeel">
            <colgroup>
              <col class="col-group" />
              <col class="col-name" />
              <col class="col-slot" />
              <col class="col-slot" />
              <col class="col-slot" />
            </colgroup>

            <thead>
              <tr>
                <th class="no-vlines">Groep</th>
                <th class="no-vlines">Voornaam</th>

                <th class="slot-head">
                  <button type="button" class="btn slot-badge" data-slot="{{ selected_day_ctx.iso }}|morning">
                    <span class="slot-label">Ochtend</span>
                    <span class="slot-count">({{ selected_day_ctx.morning_count }})</span>
                  </button>
                </th>

                <th class="slot-head">
                  <button type="button" class="btn slot-badge" data-slot="{{ selected_day_ctx.iso }}|afternoon">
                    <span class="slot-label">Middag</span>
                    <span class="slot-count">({{ selected_day_ctx.afternoon_count }})</span>
                  </button>
                </th>

                <th class="slot-head">
                  <button type="button" class="btn slot-badge" data-slot="{{ selected_day_ctx.iso }}|evening">
                    <span class="slot-label">Avond</span>
                    <span class="slot-count">({{ selected_day_ctx.evening_count }})</span>
                  </button>
                </th>
              </tr>
            </thead>

            <tbody id="matrixBody">
              {% for r in rows %}
                <tr class="matrix-row"
                    data-user-id="{{ r.user_id }}"
                    data-group="{{ r.group }}"
                    data-firstname="{{ r.firstname }}"
                    {{ r.data_attrs|safe }}>

                  <td class="cell-wrap no-vlines">{{ r.group }}</td>
                  <td class="cell-wrap no-vlines">{{ r.firstname }}</td>

                  <td class="slot-cell">
                    <div
                      class="avail-rect {% if r.cell.morning %}available{% endif %}"
                      aria-label="Ochtend"
                      role="button"
                      tabindex="{% if r.cell.morning %}0{% else %}-1{% endif %}"
                      data-user-id="{{ r.user_id }}"
                      data-group="{{ r.group }}"
                      data-firstname="{{ r.firstname }}"
                      data-date="{{ selected_day_ctx.iso }}"
                      data-period="morning"></div>
                  </td>

                  <td class="slot-cell">
                    <div
                      class="avail-rect {% if r.cell.afternoon %}available{% endif %}"
                      aria-label="Middag"
                      role="button"
                      tabindex="{% if r.cell.afternoon %}0{% else %}-1{% endif %}"
                      data-user-id="{{ r.user_id }}"
                      data-group="{{ r.group }}"
                      data-firstname="{{ r.firstname }}"
                      data-date="{{ selected_day_ctx.iso }}"
                      data-period="afternoon"></div>
                  </td>

                  <td class="slot-cell">
                    <div
                      class="avail-rect {% if r.cell.evening %}available{% endif %}"
                      aria-label="Avond"
                      role="button"
                      tabindex="{% if r.cell.evening %}0{% else %}-1{% endif %}"
                      data-user-id="{{ r.user_id }}"
                      data-group="{{ r.group }}"
                      data-firstname="{{ r.firstname }}"
                      data-date="{{ selected_day_ctx.iso }}"
                      data-period="evening"></div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
    </div>

    <!-- Rechts: actiepaneel -->
    <div class="card">
      <div class="card-inner pd-actionpanel">
        <div class="pd-ap-head">
          <div>
            <h3 style="margin:0;">Actiepaneel</h3>
            <p class="pd-subtitle" style="margin:4px 0 0 0;">
              Selecteer links diensten en wijs hier locatie/taak toe.
            </p>
          </div>

          <div class="pd-ap-summary">
            <div class="pd-pill">
              <span class="pd-pill-label">Geselecteerd</span>
              <span class="pd-pill-value" id="pdSelectedCount">0</span>
            </div>
          </div>
        </div>

        <hr class="crud-divider">

        <section class="pd-ap-section">
          <div class="pd-sec-head">
            <h4 class="pd-sec-title">Toe te wijzen diensten</h4>
            <span class="pd-sec-meta" id="pdSelectionMeta">0</span>
          </div>

          <div class="pd-list" id="pdSelectionList">
            <div class="pd-empty" id="pdSelectionEmpty">
              Selecteer links één of meerdere diensten (oranje of groen).
            </div>
          </div>
        </section>

        <section class="pd-ap-section">
          <div class="pd-sec-head">
            <h4 class="pd-sec-title">Locaties</h4>
            <span class="pd-sec-meta">X/Y = ingepland/min</span>
          </div>

          <div id="pdLocationPills" class="pd-pill-row" role="tablist" aria-label="Locaties"></div>
          <div id="pdLocationPanels" style="margin-top:10px;"></div>
        </section>

        <div class="pd-ap-actions">
          <button class="btn" id="pdSaveConceptBtn" disabled>
            Concept opslaan
          </button>
        </div>

      </div>
    </div>

  </div>

</div>

{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/personeelsdashboard/personeelsdashboard.js' %}" defer></script>
  <script src="{% static 'js/personeelsdashboard/actiepaneel.js' %}" defer></script>
{% endblock %}
