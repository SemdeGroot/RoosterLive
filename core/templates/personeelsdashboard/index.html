{% extends "base.html" %}
{% load static i18n %}

{% block title %}Teamdashboard{% endblock %}
{% block header_title %}Teamdashboard{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{% static 'css/personeelsdashboard/personeelsdashboard.css' %}">
  <link rel="stylesheet" href="{% static 'css/base/table.css' %}">
  <link rel="stylesheet" href="{% static 'css/admin/admin_panel.css' %}">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/base/select2_dropdown.css' %}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="admin-wrap pd-wrap">

  <!-- Top card -->
  <div class="card">
    <div class="card-inner">

      <div class="birthday-header agenda-section-header">
        <span class="birthday-icon icon-badge i-slate"
              style="--icon: url('{% static 'img/lucide/teamdashboard-lucide.svg' %}');"
              aria-hidden="true"></span>
        <div class="birthday-header-text">
          <h2>Diensten beheren</h2>
          <p>Plan de week in per taak of per medewerker door op de cellen te klikken. Wijzigingen worden automatisch als concept opgeslagen en zijn zichtbaar na publicatie.</p>
        </div>
        <a href="{% url 'personeel_tiles' %}" class="btn btn-save">Terug naar Personeel</a>
      </div>

      <hr class="crud-divider">

      <!-- Control bar: week picker + donuts + publish -->
      <div class="pd-controlbar">

        <div class="pd-weekcenter">
          <div class="week-wrap">
            <div class="week-controls">
              <button id="prevWeekBtn" class="btn btn-icon"
                      {% if not has_prev %}disabled aria-disabled="true"{% endif %}
                      data-target="{{ prev_monday|date:'Y-m-d' }}"
                      aria-label="Vorige week">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" stroke-width="2"
                     stroke-linecap="round" stroke-linejoin="round">
                  <path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>
                </svg>
              </button>

              <div class="week-picker">
                <button id="weekPickerBtn" class="btn week-picker-btn"
                        aria-haspopup="listbox" aria-expanded="false" aria-controls="weekMenu">
                  <span class="wp-label">{{ header_title }}</span>
                  <span class="wp-caret" aria-hidden="true">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                         viewBox="0 0 24 24" fill="none" stroke="currentColor"
                         stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="6 9 12 15 18 9"/>
                    </svg>
                  </span>
                </button>

                <div id="weekMenu" class="week-menu" role="listbox" tabindex="-1" hidden>
                  {% for opt in week_options %}
                    <div role="option"
                         class="week-option{% if opt.value == monday|date:'Y-m-d' %} is-active{% endif %}"
                         data-value="{{ opt.value }}"
                         aria-selected="{% if opt.value == monday|date:'Y-m-d' %}true{% else %}false{% endif %}">
                      <strong>Week {{ opt.iso_week }} – {{ opt.iso_year }}</strong>
                      <small>({{ opt.start|date:"d-m" }} – {{ opt.end|date:"d-m" }})</small>
                    </div>
                  {% endfor %}
                </div>
              </div>

              <button id="nextWeekBtn" class="btn btn-icon"
                      {% if not has_next %}disabled aria-disabled="true"{% endif %}
                      data-target="{{ next_monday|date:'Y-m-d' }}"
                      aria-label="Volgende week">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" stroke-width="2"
                     stroke-linecap="round" stroke-linejoin="round">
                  <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
                </svg>
              </button>
            </div>
            <div class="availability-daterange">
              {{ monday|date:"d-m-Y" }} – {{ week_end|date:"d-m-Y" }}
            </div>
          </div>
        </div>

        <!-- Donuts row -->
        <div class="pd-donuts-row" id="pdDonutsRow" aria-label="Planningsstatus per dag">
          <!-- JS fills this with 6 small + 1 big donut canvas -->
        </div>

        <!-- Publish button -->
        <div class="pd-publish-area">
          <button class="btn btn-save" id="pdPublishWeekBtn" type="button">
            Publiceer weekrooster
          </button>
          <div class="pd-unpublished-badge" id="pdUnpublishedBadge">
            <span id="pdUnpublishedCount">0</span> ongepubliceerde wijzigingen
          </div>
        </div>

      </div>

      <p class="pd-hint-muted">* Vaste medewerkers zijn <strong>dikgedrukt</strong>.</p>
      <!-- Location legend — JS fills this from PD.locations -->
      <div id="pdLegend" class="pd-legend"></div>
    </div>
  </div>

  {{ pd_data|json_script:"pd-data" }}

  <!-- Main planning card -->
  <div class="card" style="margin-top:14px;">
    <div class="card-inner">

      <!-- Tab bar: Vul shifts left, segmented control centered -->
      <div class="pd-tab-bar">
        <div>
          <button class="btn" id="pdCopyPrevWeekBtn" type="button">
            Vul shifts
          </button>
        </div>
        <div class="pd-seg-ctrl" role="tablist" aria-label="Planning weergave">
          <button class="pd-seg-btn is-active" id="segTabTask" role="tab"
                  aria-selected="true" aria-controls="tabTask" type="button">
            Planning per taak
          </button>
          <button class="pd-seg-btn" id="segTabUser" role="tab"
                  aria-selected="false" aria-controls="tabUser" type="button">
            Planning per medewerker
          </button>
        </div>
        <div></div>
      </div>

      <!-- Tab: per taak -->
      <div id="tabTask" role="tabpanel" aria-labelledby="segTabTask">
        <div class="search-bar">
          <input type="text" id="taskSearch" class="admin-input" placeholder="Zoek op taak, medewerker, locatie…">
        </div>
        <div class="table-scroll pd-grid-scroll" id="taskTableWrap">
          <!-- JS renders the planning grid here -->
        </div>
      </div>

      <!-- Tab: per werknemer -->
      <div id="tabUser" role="tabpanel" aria-labelledby="segTabUser" hidden>
        <div class="search-bar">
          <input type="text" id="userSearch" class="admin-input" placeholder="Zoek op medewerker, taak, functie, locatie…">
        </div>
        <div class="table-scroll pd-grid-scroll" id="userTableWrap">
          <!-- JS renders the planning grid here -->
        </div>
      </div>

    </div>
  </div>

</div>

<!-- Slot modal — display controlled via .is-open CSS class, not hidden attribute -->
<div class="pd-modal-backdrop" id="pdModalBackdrop" aria-hidden="true"></div>
<div class="pd-modal" id="pdModal" role="dialog" aria-modal="true" aria-labelledby="pdModalTitle">
  <div class="pd-modal-header">
    <div>
      <div class="pd-modal-title" id="pdModalTitle">Slot</div>
      <div class="pd-modal-meta" id="pdModalMeta"></div>
    </div>
    <button class="pd-modal-close" id="pdModalClose" aria-label="Sluiten" type="button">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
           stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>
  </div>
  <div class="pd-modal-body">
    <div class="pd-modal-min" id="pdModalMin"></div>
    <div style="margin-top:10px;">
      <select id="pdModalSelect" style="width:100%;"></select>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="{% static 'js/personeelsdashboard/personeelsdashboard.js' %}" defer></script>
{% endblock %}
