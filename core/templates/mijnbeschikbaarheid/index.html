{% extends "base.html" %}
{% load i18n %}

{% block title %}Beschikbaarheid{% endblock %}
{% block header_title %}Beschikbaarheid{% endblock %}

{% block head %}
<style>
  /* --- Tabel strak en uitgelijnd --- */
  .availability-wrap { overflow-x:auto; }
  .availability-table { width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed; }
  .availability-table colgroup col:first-child { width:44%; }
  .availability-table colgroup col:nth-child(2),
  .availability-table colgroup col:nth-child(3) { width:28%; }
  .availability-table thead th { padding:12px 14px; text-align:center; font-weight:700; }
  .availability-table thead th:first-child { text-align:left; }
  .availability-table tbody td { padding:12px 14px; vertical-align:middle; }
  .availability-table tbody td:nth-child(2),
  .availability-table tbody td:nth-child(3) { text-align:center; }

  .availability-table tbody tr { border-bottom:1px solid var(--border); }
  .availability-table tbody tr:nth-child(odd) { background: rgba(255,255,255,0.02); }

  .weekday-title { display:flex; gap:.6rem; align-items:baseline; }
  .weekday-title small { color: var(--muted); font-weight:500; }

  .availability-table input[type="checkbox"]{
    width:18px; height:18px; cursor:pointer; accent-color: var(--accent);
  }

  /* --- Controls (nieuwe gecombineerde week-picker) --- */
.week-controls {
  display: flex;
  align-items: center;
  justify-content: flex-start;  /* links uitgelijnd standaard (desktop) */
  gap: 10px;
  margin-bottom: 10px;
  flex-wrap: wrap;
}
  .btn{
    background:#17212b;
    border:1px solid var(--border);
    color:var(--text);
    padding:10px 14px;
    border-radius:10px;
    cursor:pointer;
    transition:background .2s ease, border-color .2s ease;
  }
  .btn:hover{ background:#1f2d3d; border-color:var(--accent); }
  .btn-icon { width:44px; height:44px; padding:0; display:grid; place-items:center; }

  .week-picker { position:relative; }
  .week-picker-btn {
    display:flex; align-items:center; gap:8px;
    min-width:260px; justify-content:center;
  }
  .week-picker-btn[aria-expanded="true"] .wp-caret { transform: rotate(180deg); }
  .wp-caret { transition: transform .15s ease; }

.week-menu {
  position: absolute;
  top: calc(100% + 6px);
  left: 50%;
  transform: translateX(-50%);
  min-width: 340px;  /* üîπ breder dan knop */
  max-height: 280px;
  overflow: auto;
  background: #0f1620;
  border: 1px solid var(--border);
  border-radius: 10px;
  box-shadow: 0 8px 24px rgba(0,0,0,.3);
  padding: 6px;
  z-index: 30;
}

  .week-option {
    display:flex; align-items:baseline; justify-content:space-between;
    gap:10px; padding:10px 12px; border-radius:8px; cursor:pointer;
  }
  .week-option:hover, .week-option:focus { background:#1a2432; outline:none !important; box-shadow: none; border: none; }
  .week-option.is-active { border:1px solid var(--accent); }
  .week-option small { color: var(--muted); }

  .availability-daterange { margin:4px 0 16px; color:var(--muted); font-weight:500; }

  @media (max-width: 640px) {
    .weekday-title { flex-direction:column; gap:0; }
    .week-picker-btn { min-width:220px; }
      .week-controls {
    justify-content: center;
  }}
</style>
{% endblock %}

{% block content %}
<div class="card">
  <div class="form">
    <h3 style="margin:0 0 8px 0;">Vink hier je beschikbaarheid aan voor:</h3>

    <!-- üîπ Nieuwe weeknavigatie met dropdown -->
    <div class="week-controls">

      <!-- Vorige week -->
      <button id="prevWeekBtn"
              class="btn btn-icon"
              {% if not has_prev %}disabled aria-disabled="true"{% endif %}
              data-target="{{ prev_monday|date:'Y-m-d' }}"
              aria-label="Vorige week">‚Üê</button>

      <!-- Centrale dropdown -->
      <div class="week-picker">
        <button id="weekPickerBtn"
                class="btn week-picker-btn"
                aria-haspopup="listbox"
                aria-expanded="false"
                aria-controls="weekMenu">
          <span class="wp-label">{{ header_title }}</span>
          <span class="wp-caret" aria-hidden="true">‚ñæ</span>
        </button>

        <div id="weekMenu" class="week-menu" role="listbox" tabindex="-1" hidden>
          {% for opt in week_options %}
            <div role="option"
                 class="week-option{% if opt.value == monday|date:'Y-m-d' %} is-active{% endif %}"
                 data-value="{{ opt.value }}"
                 aria-selected="{% if opt.value == monday|date:'Y-m-d' %}true{% else %}false{% endif %}">
              <strong>Week {{ opt.iso_week }} ‚Äì {{ opt.iso_year }}</strong>
              <small>({{ opt.start|date:"d-m" }} ‚Äì {{ opt.end|date:"d-m" }})</small>
            </div>
          {% endfor %}
        </div>
      </div>

      <!-- Volgende week -->
      <button id="nextWeekBtn"
              class="btn btn-icon"
              {% if not has_next %}disabled aria-disabled="true"{% endif %}
              data-target="{{ next_monday|date:'Y-m-d' }}"
              aria-label="Volgende week">‚Üí</button>
    </div>

    <!-- Weekrange -->
    <div class="availability-daterange">
      {{ monday|date:"d-m-Y" }} ‚Äì {{ week_end|date:"d-m-Y" }}
    </div>

    <!-- Formulier -->
    <form id="availabilityForm" method="post" action="">
      {% csrf_token %}
      <input type="hidden" id="redirectToMonday" name="redirect_to_monday" value="">

      <div class="availability-wrap">
        <table class="availability-table" aria-label="Beschikbaarheid maandag t/m vrijdag">
          <colgroup><col /><col /><col /></colgroup>
          <thead>
            <tr><th>Dag</th><th>Ochtend</th><th>Middag</th></tr>
          </thead>
          <tbody>
            {% for r in rows %}
              <tr>
                <td>
                  <div class="weekday-title">
                    <strong>{{ r.date|date:"l"|capfirst }}</strong>
                    <small>{{ r.date|date:"d-m-Y" }}</small>
                  </div>
                </td>
                <td><input type="checkbox" name="morning_{{ r.date|date:'Y-m-d' }}" {% if r.morning %}checked{% endif %}></td>
                <td><input type="checkbox" name="afternoon_{{ r.date|date:'Y-m-d' }}" {% if r.afternoon %}checked{% endif %}></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div style="display:flex; justify-content:flex-end; margin-top:16px;">
        <button type="submit" class="btn">Opslaan</button>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  const form = document.getElementById('availabilityForm');
  const redirectField = document.getElementById('redirectToMonday');
  const checkboxes = Array.from(form.querySelectorAll('input[type="checkbox"]'));
  const initial = new Map(checkboxes.map(cb => [cb.name, cb.checked]));
  const PROMPT = "Wil je je beschikbaarheid opslaan?";

  const isDirty  = () => checkboxes.some(cb => cb.checked !== initial.get(cb.name));
  const saveThenGo = (targetISO) => { redirectField.value = targetISO || ""; form.submit(); };
  const discardAndGo = (targetISO) => {
    const url = new URL(window.location.href);
    url.searchParams.set('monday', targetISO);
    window.location.href = url.toString();
  };

  // --- Nieuwe week-picker gedrag ---
  const btnPrev = document.getElementById('prevWeekBtn');
  const btnNext = document.getElementById('nextWeekBtn');
  const pickerBtn = document.getElementById('weekPickerBtn');
  const menu = document.getElementById('weekMenu');

  function goTo(targetISO){
    if (!isDirty()) return discardAndGo(targetISO);
    if (confirm(PROMPT)) saveThenGo(targetISO);
    else discardAndGo(targetISO);
  }

  function bindArrow(btn){
    if (!btn || btn.disabled) return;
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const target = btn.dataset.target;
      if (target) goTo(target);
    });
  }
  bindArrow(btnPrev);
  bindArrow(btnNext);

  function openMenu(){
    if (!menu) return;
    menu.hidden = false;
    pickerBtn.setAttribute('aria-expanded','true');
    menu.focus({ preventScroll:true });
  }
  function closeMenu(){
    if (!menu) return;
    menu.hidden = true;
    pickerBtn.setAttribute('aria-expanded','false');
  }

  pickerBtn?.addEventListener('click', (e)=>{
    e.preventDefault();
    const isOpen = pickerBtn.getAttribute('aria-expanded') === 'true';
    isOpen ? closeMenu() : openMenu();
  });

  menu?.addEventListener('click', (e)=>{
    const opt = e.target.closest('.week-option');
    if (!opt) return;
    goTo(opt.dataset.value);
    closeMenu();
  });

  menu?.addEventListener('keydown', (e)=>{
    const opts = Array.from(menu.querySelectorAll('.week-option'));
    const idx = opts.indexOf(document.activeElement);
    if (e.key === 'Escape'){ closeMenu(); pickerBtn.focus(); }
    else if (e.key === 'ArrowDown'){
      e.preventDefault();
      (opts[idx+1] || opts[0]).focus();
    } else if (e.key === 'ArrowUp'){
      e.preventDefault();
      (opts[idx-1] || opts[opts.length-1]).focus();
    } else if (e.key === 'Enter' || e.key === ' '){
      e.preventDefault();
      const opt = document.activeElement;
      if (opt?.classList.contains('week-option')) {
        goTo(opt.dataset.value);
        closeMenu();
      }
    }
  });

  menu?.querySelectorAll('.week-option').forEach(el => el.setAttribute('tabindex','-1'));

  document.addEventListener('click', (e)=>{
    if (!menu || menu.hidden) return;
    if (e.target === pickerBtn || pickerBtn.contains(e.target)) return;
    if (menu.contains(e.target)) return;
    closeMenu();
  });

  window.addEventListener('pageshow', () => {
    checkboxes.forEach(cb => initial.set(cb.name, cb.checked));
  });
})();
</script>
{% endblock %}