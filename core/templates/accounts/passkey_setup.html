{% extends "two_factor/_base.html" %}
{% load static i18n %}

{% block login_header_image %}
  <div class="twofa-image-wrap">
    <img src="{% static 'img/biometric.png' %}" alt="Biometrisch inloggen" class="twofa-image">
  </div>
{% endblock %}

{% block content %}

  <section id="passkeySetupSection"
           class="passkey-setup"
           style="display:none;">
    <h1 style="text-align:center;">Snel inloggen met een passkey</h1>
    <p class="twofa-logintext muted">
      Op dit apparaat kun je Face ID, Touch ID of een andere biometrische beveiliging gebruiken
      om voortaan <strong>zonder 2FA-code</strong> in te loggen.
    </p>
    <p class="twofa-logintext">
      We koppelen éénmalig een passkey aan dit specifieke apparaat. Daarna kun je met één tik inloggen.
    </p>

    <div class="passkey-actions" style="margin-top:1.5rem; text-align:center;">
      <button type="button" id="passkeySetupBtn">
        Instellen
      </button>
      <a href="{{ next_url }}" id="passkeySkipBtn" class="passkey-skip-btn">
        Overslaan
      </a>
    </div>

    <p id="passkeyMessage" class="passkey-message" aria-live="polite"></p>
  </section>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const section = document.getElementById("passkeySetupSection");
      const btn     = document.getElementById("passkeySetupBtn");
      const msgEl   = document.getElementById("passkeyMessage");
      const nextUrl = "{{ next_url|escapejs }}";

      const onHttps = location.protocol === "https:" || location.hostname === "localhost";

      function isMobile() {
        const ua = navigator.userAgent || "";
        return /Android|iPhone|iPad|iPod/i.test(ua);
      }

      function isWebAuthnSupported() {
        return (
          typeof window.PublicKeyCredential !== "undefined" &&
          typeof window.navigator.credentials !== "undefined" &&
          typeof window.navigator.credentials.get === "function"
        );
      }

      // Als geen HTTPS, geen WebAuthn of geen mobiel → direct terug
      if (!onHttps || !isMobile() || !isWebAuthnSupported()) {
        window.location.href = nextUrl || "/";
        return;
      }

      // Alleen hier: sectie zichtbaar maken
      if (section) {
        section.style.display = "";
      }

      // Koppeling met jouw bestaande setupPasskey() uit passkeys.js
      if (btn && window.setupPasskey) {
        btn.addEventListener("click", () => {
          window.setupPasskey(nextUrl, msgEl);
        });
      }

      // Optioneel: "Overslaan" laten werken zonder layout glitches (JS niet strikt nodig)
      const skipBtn = document.getElementById("passkeySkipBtn");
      if (skipBtn) {
        skipBtn.addEventListener("click", (ev) => {
          // je kunt hier desgewenst nog /api/passkeys/skip/ aanroepen met device_hash
          // maar standaard mag de link gewoon navigeren
        });
      }
    });
  </script>
{% endblock %}