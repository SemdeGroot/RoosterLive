{% extends "base.html" %}
{% load static role_tags form_extras %}
{% block title %}Beheer{% endblock %}
{% block header_title %}Beheer{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{% static 'css/base/table.css' %}">
  <link rel="stylesheet" href="{% static 'css/admin/admin_panel.css' %}">

  <script src="{% static 'js/base/table.js' %}" defer></script>
  <script src="{% static 'js/admin/admin_panel.js' %}" defer></script>

  <!-- IMask voor invoermask op dd-mm-jjjj -->
  <script src="https://unpkg.com/imask"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      document.querySelectorAll(".js-date").forEach(function (input) {
        IMask(input, {
          mask: 'd-m-Y',
          lazy: true,
          overwrite: true,
          autofix: false,
          blocks: {
            d: { mask: IMask.MaskedRange, from: 1, to: 31, maxLength: 2 },
            m: { mask: IMask.MaskedRange, from: 1, to: 12, maxLength: 2 },
            Y: { mask: IMask.MaskedRange, from: 1900, to: 2100, maxLength: 4 }
          }
        });
      });
    });
  </script>
{% endblock %}

{% block content %}
<div class="admin-wrap">
  <div class="admin-grid">

    <!-- ===================== -->
    <!-- GROEPEN -->
    <!-- ===================== -->
    <div class="card">
      <div class="card-inner">

        <h3 style="margin-top:0;">{% if editing_group %}Groep bewerken{% else %}Groep toevoegen{% endif %}</h3>

        <form method="post" autocomplete="off">
          {% csrf_token %}
          <input type="hidden" name="form_kind" value="group">
          {% if editing_group_id %}
            <input type="hidden" name="group_id" value="{{ editing_group_id }}">
          {% endif %}

          {{ group_form.non_field_errors }}
          {{ group_form.errors }}

          <div class="form form-sticky-actions" style="padding:0;">
            <label for="{{ group_form.name.id_for_label }}">Groepsnaam:</label>
            {{ group_form.name }}

            <strong style="font-size:1.1rem; display:block; margin-top:0px;">Permissies</strong>

            {% for section_title, fields in perm_sections %}
              <div class="perm-section-title">{{ section_title }}</div>
              <div class="perms-grid">
                {% for code in fields %}
                  {% if group_form.fields|has_key:code %}
                    {% with bf=group_form|field:code %}
                      {% if bf %}
                        <label class="perm-row">
                          {{ bf }}
                          <span>{{ perm_labels|get_item:code|default:bf.label|default:code }}</span>
                        </label>
                      {% endif %}
                    {% endwith %}
                  {% endif %}
                {% endfor %}
              </div>
            {% endfor %}

            <button class="btn group-save" type="submit">Opslaan</button>
          </div>
        </form>

        <hr>
        <h3 style="margin-top:0;">Bestaande groepen</h3>

        <div class="search-bar">
          <input type="text" id="groupSearch" placeholder="Typ om te zoeken…">
        </div>

        <div data-crud data-table="#groupTable" data-rows="#groupTable .group-row" data-page-size="10">
          <div class="table-scroll">
            <table class="crud-table compact group-table" id="groupTable">
              <thead>
                <tr>
                  <th>Groep</th>
                  <th>Permissies</th>
                  <th class="center-col">Leden</th>
                  <th>Acties</th>
                </tr>
              </thead>

              <tbody>
                {% for row in group_rows %}
                <tr class="group-row" id="group-row-{{ row.group.id }}">
                  <td>{{ row.group.name }}</td>

                  <td class="wrap">
                    {% if row.perm_labels %}
                      {% for lbl in row.perm_labels %}<div>{{ lbl }}</div>{% endfor %}
                    {% else %}
                      -
                    {% endif %}
                  </td>

                  <td class="center-col">{{ row.member_count }}</td>

                  <td>
                    <div class="actions-wrap horizontal">
                      <!-- EDIT: groep edit is een GET -->
                      <form method="get">
                        <input type="hidden" name="group_id" value="{{ row.group.id }}">
                        <button class="icon-btn" type="submit" aria-label="Bewerken">
                          <!-- EDIT SVG -->
                          <svg viewBox="0 0 24 24" width="16" height="16" fill="none"
                               stroke="currentColor" stroke-width="2"
                               stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 20h9"/>
                            <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/>
                          </svg>
                        </button>
                      </form>

                      <!-- DELETE -->
                      <form method="post"
                            action="{% url 'group_delete' row.group.id %}"
                            onsubmit="return confirmGroupDelete('{{ row.group.name|escapejs }}');">
                        {% csrf_token %}
                        <button class="icon-btn danger" type="submit" aria-label="Verwijderen">
                          <!-- DELETE SVG (jouw svg) -->
                          <svg viewBox="0 0 24 24" width="16" height="16" fill="none"
                               stroke="currentColor" stroke-width="2"
                               stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            <line x1="10" y1="11" x2="10" y2="17"/>
                            <line x1="14" y1="11" x2="14" y2="17"/>
                          </svg>
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="crud-more-wrap">
            <button class="btn small" type="button" data-crud-more>Toon meer</button>
          </div>
        </div>

      </div>
    </div>

    <!-- ===================== -->
    <!-- USERS -->
    <!-- ===================== -->
    <div class="card">
      <div class="card-inner">
        <h3 style="margin-top:0;">Gebruiker toevoegen</h3>

        <form method="post" autocomplete="off">
          {% csrf_token %}
          <input type="hidden" name="form_kind" value="user_create">

          {{ user_form.non_field_errors }}
          {{ user_form.errors }}

          <div class="form form-sticky-actions" style="padding:0;">
            {{ user_form.first_name.label_tag }} {{ user_form.first_name }}
            {{ user_form.last_name.label_tag }} {{ user_form.last_name }}
            {{ user_form.email.label_tag }} {{ user_form.email }}
            {{ user_form.birth_date.label_tag }} {{ user_form.birth_date }}
            {{ user_form.group.label_tag }} {{ user_form.group }}
            {{ user_form.organization.label_tag }} {{ user_form.organization }}

            <button class="btn user-create" type="submit">Aanmaken</button>
          </div>
        </form>

        <hr>
        <h3 style="margin-top:0;">Bestaande gebruikers</h3>

        <div class="search-bar">
          <input type="text" id="userSearch" placeholder="Typ om te zoeken…">
        </div>

        <div data-crud data-table="#userTable" data-rows="#userTable .user-row" data-page-size="10">
          <div class="table-scroll">
            <table class="crud-table compact user-table" id="userTable">
              <thead>
                <tr>
                  <th class="center-col">Actief</th>
                  <th>Voornaam</th>
                  <th>Achternaam</th>
                  <th>Organisatie</th>
                  <th>Groep</th>
                  <th>Acties</th>
                </tr>
              </thead>

              <tbody>
                {% for u in users %}
                <tr class="user-row" id="user-row-{{ u.id }}">
                  <td class="center-col"
                      title="{% if u.has_usable_password %}Account actief{% else %}Nog niet geactiveerd{% endif %}">
                    {% if u.has_usable_password %}✅{% else %}⛔{% endif %}
                  </td>

                  <td title="{{ u.username }}">{{ u.first_name|default:u.username }}</td>
                  <td>{{ u.last_name }}</td>

                  <td class="wrap">
                    {% if u.profile and u.profile.organization %}
                      {{ u.profile.organization.name }}
                    {% else %}
                      -
                    {% endif %}
                  </td>

                  <td>
                    {% with g=u.groups.all|first %}
                      {{ g.name|default:"-" }}
                    {% endwith %}
                  </td>

                  <td>
                    <div class="actions-wrap horizontal">
                      <!-- EDIT toggle -->
                      <button type="button"
                              class="icon-btn"
                              onclick="toggleEdit('{{ u.id }}')"
                              aria-label="Bewerken">
                        <!-- EDIT SVG -->
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none"
                             stroke="currentColor" stroke-width="2"
                             stroke-linecap="round" stroke-linejoin="round">
                          <path d="M12 20h9"/>
                          <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/>
                        </svg>
                      </button>

                      <!-- DELETE -->
                      <form method="post"
                            action="{% url 'user_delete' u.id %}"
                            onsubmit="return confirmDelete('{{ u.first_name|default:u.username }}');">
                        {% csrf_token %}
                        <button class="icon-btn danger" type="submit" aria-label="Verwijderen">
                          <!-- DELETE SVG -->
                          <svg viewBox="0 0 24 24" width="16" height="16" fill="none"
                               stroke="currentColor" stroke-width="2"
                               stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            <line x1="10" y1="11" x2="10" y2="17"/>
                            <line x1="14" y1="11" x2="14" y2="17"/>
                          </svg>
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>

                <!-- EDIT ROW -->
                <tr id="edit-row-{{ u.id }}" class="edit-row" style="display:none;">
                  <td colspan="6">
                    <div class="edit-wrap">
                      <form method="post" action="{% url 'user_update' u.id %}">
                        {% csrf_token %}

                        <div class="edit-grid">
                          <div>
                            <label>Voornaam:</label>
                            <input class="admin-input" type="text" name="first_name"
                                   value="{{ u.first_name|default:u.username }}" style="margin-top:6px;">
                          </div>
                          <div>
                            <label>Achternaam:</label>
                            <input class="admin-input" type="text" name="last_name"
                                   value="{{ u.last_name }}" style="margin-top:6px;">
                          </div>
                          <div>
                            <label>E-mail:</label>
                            <input class="admin-input" type="email" name="email"
                                   value="{{ u.email }}" style="margin-top:6px;">
                          </div>
                          <div>
                            <label>Geboortedatum:</label>
                            <input class="admin-input js-date" type="text" name="birth_date"
                                   value="{% if u.profile and u.profile.birth_date %}{{ u.profile.birth_date|date:'d-m-Y' }}{% endif %}"
                                   placeholder="dd-mm-jjjj" autocomplete="off" style="margin-top:6px;">
                          </div>
                          <div>
                            <label>Groep:</label>
                            <select name="group" class="admin-select narrow" style="margin-top:6px;">
                              {% with g=u.groups.all|first %}
                                {% for grp in groups %}
                                  <option value="{{ grp.id }}" {% if g and g.id == grp.id %}selected{% endif %}>
                                    {{ grp.name }}
                                  </option>
                                {% endfor %}
                              {% endwith %}
                            </select>
                          </div>
                          <div>
                            <label>Organisatie:</label>
                            <select name="organization" class="admin-select narrow" style="margin-top:6px;">
                              <option value="">----------</option>
                              {% with profile=u.profile %}
                                {% for org in organizations %}
                                  <option value="{{ org.id }}"
                                          {% if profile.organization and profile.organization.id == org.id %}selected{% endif %}>
                                    {{ org.name }}
                                  </option>
                                {% endfor %}
                              {% endwith %}
                            </select>
                          </div>
                        </div>

                        <div class="actions-wrap horizontal" style="margin-top:12px;">
                          <button class="btn" type="submit">Opslaan</button>
                          <button type="button" class="btn" onclick="toggleEdit('{{ u.id }}')">Annuleren</button>
                        </div>
                      </form>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="crud-more-wrap">
            <button class="btn small" type="button" data-crud-more>Toon meer</button>
          </div>
        </div>

      </div>
    </div>

    <!-- ===================== -->
    <!-- ORGS -->
    <!-- ===================== -->
    <div class="card" id="org-card">
      <div class="card-inner">
        <h3 style="margin-top:0;">Organisatie toevoegen</h3>

        <form method="post" autocomplete="off">
          {% csrf_token %}
          <input type="hidden" name="form_kind" value="org">

          <div class="form form-sticky-actions" style="padding:0;">
            <label for="org_name">Naam organisatie:</label>
            <input class="admin-input" type="text" name="name" id="org_name" required>

            <label for="org_type">Type organisatie:</label>
            <select class="admin-select narrow" name="org_type" id="org_type" required>
              <option value="apotheek" selected>Apotheek</option>
              <option value="zorginstelling">Zorginstelling</option>
            </select>

            <label for="org_email">E-mailadres:</label>
            <input class="admin-input" type="email" name="email" id="org_email" required>

            <label for="org_email2">E-mailadres 2:</label>
            <input class="admin-input" type="email" name="email2" id="org_email2">

            <label for="org_phone">Telefoonnummer:</label>
            <input class="admin-input" type="text" name="phone" id="org_phone">

            <button class="btn org-save" type="submit">Opslaan</button>
          </div>
        </form>

        <hr>
        <h3 style="margin-top:0;">Bestaande organisaties</h3>

        <div class="search-bar">
          <input type="text" id="orgSearch" placeholder="Typ om te zoeken…">
        </div>

        <div data-crud data-table="#orgTable" data-rows="#orgTable .org-row" data-page-size="10">
          <div class="table-scroll">
            <table class="crud-table compact org-table" id="orgTable">
              <thead>
                <tr>
                  <th>Organisatie</th>
                  <th>E-mail</th>
                  <th>Telefoon</th>
                  <th>Acties</th>
                </tr>
              </thead>

              <tbody>
                {% for org in organizations %}
                <tr class="org-row" id="org-row-{{ org.id }}">
                  <td class="wrap">{{ org.name }}</td>
                  <td class="wrap">{{ org.email|default:"-" }}</td>
                  <td class="wrap">{{ org.phone|default:"-" }}</td>

                  <td>
                    <div class="actions-wrap horizontal">
                      <!-- EDIT toggle -->
                      <button type="button"
                              class="icon-btn"
                              onclick="toggleOrgEdit('{{ org.id }}')"
                              aria-label="Bewerken">
                        <!-- EDIT SVG -->
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none"
                             stroke="currentColor" stroke-width="2"
                             stroke-linecap="round" stroke-linejoin="round">
                          <path d="M12 20h9"/>
                          <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/>
                        </svg>
                      </button>

                      <!-- DELETE -->
                      <form method="post"
                            action="{% url 'org_delete' org.id %}"
                            onsubmit="return confirmOrgDelete('{{ org.name|escapejs }}');">
                        {% csrf_token %}
                        <button class="icon-btn danger" type="submit" aria-label="Verwijderen">
                          <!-- DELETE SVG -->
                          <svg viewBox="0 0 24 24" width="16" height="16" fill="none"
                               stroke="currentColor" stroke-width="2"
                               stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            <line x1="10" y1="11" x2="10" y2="17"/>
                            <line x1="14" y1="11" x2="14" y2="17"/>
                          </svg>
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>

                <!-- EDIT ROW -->
                <tr id="org-edit-row-{{ org.id }}" class="edit-row" style="display:none;">
                  <td colspan="4">
                    <div class="edit-wrap">
                      <form method="post" action="{% url 'org_update' org.id %}">
                        {% csrf_token %}

                        <div class="edit-grid">
                          <div>
                            <label>Naam organisatie:</label>
                            <input class="admin-input" type="text" name="name"
                                   value="{{ org.name }}" style="margin-top:6px;">
                          </div>
                          <div>
                            <label>Type organisatie:</label>
                            <select name="org_type" class="admin-select narrow" style="margin-top:6px;">
                              <option value="apotheek" {% if org.org_type == "apotheek" %}selected{% endif %}>Apotheek</option>
                              <option value="zorginstelling" {% if org.org_type == "zorginstelling" %}selected{% endif %}>Zorginstelling</option>
                            </select>
                          </div>
                          <div>
                            <label>E-mailadres:</label>
                            <input class="admin-input" type="email" name="email"
                                   value="{{ org.email }}" style="margin-top:6px;">
                          </div>
                          <div>
                            <label>E-mailadres 2:</label>
                            <input class="admin-input" type="email" name="email2"
                                   value="{{ org.email2 }}" style="margin-top:6px;">
                          </div>
                          <div>
                            <label>Telefoonnummer:</label>
                            <input class="admin-input" type="text" name="phone"
                                   value="{{ org.phone }}" style="margin-top:6px;">
                          </div>
                        </div>

                        <div class="actions-wrap horizontal" style="margin-top:12px;">
                          <button class="btn" type="submit">Opslaan</button>
                          <button type="button" class="btn" onclick="toggleOrgEdit('{{ org.id }}')">Annuleren</button>
                        </div>
                      </form>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="4">Nog geen organisaties.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="crud-more-wrap">
            <button class="btn small" type="button" data-crud-more>Toon meer</button>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>
{% endblock %}
