{% extends "base.html" %}
{% load static role_tags form_extras %}
{% block title %}Beheer{% endblock %}
{% block header_title %}Beheer{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{% static 'css/admin/admin_panel.css' %}">
  <script src="{% static 'js/admin/admin_panel.js' %}" defer></script>

  <!-- IMask voor invoermask op dd-mm-jjjj -->
  <script src="https://unpkg.com/imask"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Date mask voor alle .js-date velden
      document.querySelectorAll(".js-date").forEach(function (input) {
        IMask(input, {
          mask: 'd-m-Y',
          lazy: true,
          overwrite: true,
          autofix: false,
          blocks: {
            d: { mask: IMask.MaskedRange, from: 1, to: 31, maxLength: 2 },
            m: { mask: IMask.MaskedRange, from: 1, to: 12, maxLength: 2 },
            Y: { mask: IMask.MaskedRange, from: 1900, to: 2100, maxLength: 4 }
          }
        });
      });

      // Toggle voor "nieuwe organisatie" paneel
      var toggleBtn = document.getElementById("orgAddToggle");
      var panel = document.getElementById("orgAddPanel");
      if (toggleBtn && panel) {
        toggleBtn.addEventListener("click", function () {
          if (panel.style.display === "none" || !panel.style.display) {
            panel.style.display = "block";
          } else {
            panel.style.display = "none";
          }
        });
      }
    });
  </script>
{% endblock %}

{% block content %}
<div class="admin-wrap">
  <div class="admin-grid">

    <!-- Groepen -->
    <div class="card">
      <div class="card-inner">
        <h3 style="margin-top:0;">{% if editing_group %}Groep bewerken{% else %}Groep toevoegen{% endif %}</h3>

        <form method="post" autocomplete="off">
          {% csrf_token %}
          <input type="hidden" name="form_kind" value="group">
          {% if editing_group_id %}<input type="hidden" name="group_id" value="{{ editing_group_id }}">{% endif %}

          {{ group_form.non_field_errors }}
          {{ group_form.errors }}

          <div class="form form-sticky-actions" style="padding:0;">
            <label for="{{ group_form.name.id_for_label }}">Groepsnaam:</label>
            {{ group_form.name }}

            <strong style="font-size:1.1rem; display:block; margin-top:0px;">Permissies</strong>
            {% for section_title, fields in perm_sections %}
              <div class="perm-section-title">{{ section_title }}</div>
              <div class="perms-grid">
                {% for code in fields %}
                  {% if group_form.fields|has_key:code %}
                    {% with bf=group_form|field:code %}
                      {% if bf %}
                        <label class="perm-row">
                          {{ bf }}
                          <span>{{ perm_labels|get_item:code|default:bf.label|default:code }}</span>
                        </label>
                      {% endif %}
                    {% endwith %}
                  {% endif %}
                {% endfor %}
              </div>
            {% endfor %}

            <button class="btn block group-save" type="submit">Opslaan</button>
          </div>
        </form>

        <hr style="border-color:var(--border); margin:16px 0;">
        <h3 style="margin-top:0;">Bestaande groepen</h3>

        <div class="search-bar">
          <input type="text" id="groupSearch" placeholder="Typ om te zoeken…">
        </div>

        <table class="manage-table group-table" id="groupTable">
          <thead>
            <tr>
              <th>Groep</th>
              <th>Permissies</th>
              <th>Leden</th>
              <th>Acties</th>
            </tr>
          </thead>
          <tbody>
            {% for row in group_rows %}
            <tr class="group-row" id="group-row-{{ row.group.id }}">
              <td>{{ row.group.name }}</td>
              <td>
                {% if row.perm_labels %}
                  {% for lbl in row.perm_labels %}<div>{{ lbl }}</div>{% endfor %}
                {% else %}-{% endif %}
              </td>
              <td style="text-align:center;">{{ row.member_count }}</td>
              <td>
                <div class="actions-wrap">
                  <form method="get">
                    <input type="hidden" name="group_id" value="{{ row.group.id }}">
                    <button class="btn small block" type="submit">Bewerken</button>
                  </form>
                  <form method="post" action="{% url 'group_delete' row.group.id %}" style="display:inline;"
                        onsubmit="return confirmGroupDelete('{{ row.group.name|escapejs }}');">
                    {% csrf_token %}
                    <button class="btn small danger block" type="submit">Verwijderen</button>
                  </form>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Gebruikers -->
    <div class="card">
      <div class="card-inner">
        <h3 style="margin-top:0;">Gebruiker toevoegen</h3>
        <form method="post" autocomplete="off">
          {% csrf_token %}
          <input type="hidden" name="form_kind" value="user_create">

          {{ user_form.non_field_errors }}
          {{ user_form.errors }}

          <div class="form form-sticky-actions" style="padding:0;">
            {{ user_form.first_name.label_tag }} {{ user_form.first_name }}
            {{ user_form.email.label_tag }} {{ user_form.email }}
            {{ user_form.birth_date.label_tag }} {{ user_form.birth_date }}
            {{ user_form.group.label_tag }} {{ user_form.group }}
            {{ user_form.organization.label_tag }}
            <div style="display:flex; gap:8px; align-items:flex-end; margin-top:0px">
              <div style="flex:1;">
                {{ user_form.organization }}
              </div>
              <button type="button"
                      class="btn"
                      id="orgAddToggle"
                      style="white-space:nowrap; margin-top: 0px !important; padding: 5px 10px">
                + nieuwe organisatie
              </button>
            </div>

            <button class="btn block user-create" type="submit">Aanmaken</button>
          </div>
        </form>

        <!-- Klein formulier om een nieuwe organisatie toe te voegen (uitklapbaar) -->
        <div id="orgAddPanel" style="display:none; margin-top:8px;">
          <form method="post" autocomplete="off">
            {% csrf_token %}
            <input type="hidden" name="form_kind" value="org_create">
            <div class="form form-sticky-actions" style="padding:0;">
              <label for="org_name">Nieuwe organisatie:</label>
              <div style="display:flex; gap:8px; align-items:flex-end;">
                <div style="flex:1;">
                  <input class="admin-input" type="text" name="name" id="org_name"
                        placeholder="Naam organisatie" required>
                </div>
                <button class="btn small" type="submit" style="padding: 5px 10px">Toevoegen</button>
              </div>
            </div>
          </form>
        </div>

        <hr style="border-color:var(--border); margin:16px 0;">
        <h3 style="margin-top:0;">Bestaande gebruikers</h3>

        <div class="search-bar">
          <input type="text" id="userSearch" placeholder="Typ om te zoeken…">
        </div>

        <table class="manage-table user-table" id="userTable">
          <tr>
            <th>Voornaam</th>
            <th>E-mail</th>
            <th>Groep</th>
            <th>Acties</th>
          </tr>

          {% for u in users %}
          <tr class="user-row" id="user-row-{{ u.id }}">
            <td title="{{ u.username }}">{{ u.first_name|default:u.username }}</td>
            <td title="{{ u.email }}">{{ u.email }}</td>
            <td>
              {% with g=u.groups.all|first %}
                {{ g.name|default:"-" }}
              {% endwith %}
            </td>
            <td>
              <div class="actions-wrap user-actions-vertical">
                <button type="button" class="btn small block" onclick="toggleEdit('{{ u.id }}')">Bewerken</button>
                <form method="post" action="{% url 'user_delete' u.id %}" style="display:inline;"
                      onsubmit="return confirmDelete('{{ u.first_name|default:u.username }}');">
                  {% csrf_token %}
                  <button class="btn small danger block" type="submit">Verwijderen</button>
                </form>
              </div>
            </td>
          </tr>

          <tr id="edit-row-{{ u.id }}" class="edit-row" style="display:none;">
            <td colspan="4">
              <form method="post" action="{% url 'user_update' u.id %}">
                {% csrf_token %}
                <div class="edit-grid">
                  <div>
                    <label>Voornaam:</label>
                    <input class="admin-input" type="text" name="first_name"
                           value="{{ u.first_name|default:u.username }}" style="margin-top: 6px;">
                  </div>
                  <div>
                    <label>E-mail:</label>
                    <input class="admin-input" type="email" name="email"
                           value="{{ u.email }}" style="margin-top: 6px;">
                  </div>
                  <div>
                    <label>Geboortedatum:</label>
                    <input class="admin-input js-date" type="text" name="birth_date"
                           value="{% if u.profile and u.profile.birth_date %}{{ u.profile.birth_date|date:'d-m-Y' }}{% endif %}"
                           placeholder="dd-mm-jjjj"
                           autocomplete="off"
                           style="margin-top: 6px;">
                  </div>
                  <div>
                    <label>Groep:</label>
                    <select name="group" class="admin-select narrow" style="margin-left: 4px;">
                      {% with g=u.groups.all|first %}
                        {% for grp in groups %}
                          <option value="{{ grp.id }}" {% if g and g.id == grp.id %}selected{% endif %}>
                            {{ grp.name }}
                          </option>
                        {% endfor %}
                      {% endwith %}
                    </select>
                  </div>
                  <div>
                    <label>Organisatie:</label>
                    <select name="organization" class="admin-select narrow" style="margin-left: 4px;">
                      <option value="">----------</option>
                      {% with profile=u.profile %}
                        {% for org in organizations %}
                          <option value="{{ org.id }}"
                            {% if profile.organization and profile.organization.id == org.id %}selected{% endif %}>
                            {{ org.name }}
                          </option>
                        {% endfor %}
                      {% endwith %}
                    </select>
                  </div>
                </div>
                <div class="edit-actions" style="margin-bottom: 4px;margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">
                  <button class="btn" type="submit">Opslaan</button>
                  <button type="button" class="btn" onclick="toggleEdit('{{ u.id }}')">Annuleren</button>
                </div>
              </form>
            </td>
          </tr>
          {% endfor %}
        </table>
      </div>
    </div>

  </div>
</div>
{% endblock %}