{% extends "base.html" %}
{% load static role_tags form_extras %}
{% block title %}Beheer{% endblock %}
{% block header_title %}Beheer{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{% static 'css/admin_panel/admin_panel.css' %}">
  <script src="{% static 'js/admin_panel/admin_panel.js' %}" defer></script>
{% endblock %}

{% block content %}
<div class="admin-wrap">
  <div class="admin-grid">

    <!-- Groepen -->
    <div class="card">
      <div class="card-inner">
        <h3 style="margin-top:0;">{% if editing_group %}Groep bewerken{% else %}Nieuwe groep{% endif %}</h3>

        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="form_kind" value="group">
          {% if editing_group_id %}<input type="hidden" name="group_id" value="{{ editing_group_id }}">{% endif %}

          {{ group_form.non_field_errors }}
          {{ group_form.errors }}

          <div class="form" style="padding-top:0;">
            Groepsnaam: {{ group_form.name }}

            <!-- Dynamisch laden -->
             <strong style="font-size:1.1rem; display:block; margin-top:4px;">Permissies</strong>
            {% for section_title, fields in perm_sections %}
              <div class="perm-section-title">{{ section_title }}</div>
              <div class="perms-grid">
                {% for code in fields %}
                  {% if group_form.fields|has_key:code %}
                    {% with bf=group_form|field:code %}
                      {% if bf %}
                        <label class="perm-row">
                          {{ bf }}
                          <span>{{ perm_labels|get_item:code|default:bf.label|default:code }}</span>
                        </label>
                      {% endif %}
                    {% endwith %}
                  {% endif %}
                {% endfor %}
              </div>
            {% endfor %}

            <button class="btn group-save" type="submit">Opslaan</button>
          </div>
        </form>

        <hr style="border-color:var(--border); margin:16px 0;">
        <h3 style="margin-top:0;">Bestaande groepen</h3>

        <table class="manage-table" id="groupTable">
          <tr>
            <th>Groep</th>
            <th>Permissies</th>
            <th>Leden</th>
            <th>Acties</th>
          </tr>
          {% for row in group_rows %}
          <tr id="group-row-{{ row.group.id }}">
            <td>{{ row.group.name }}</td>
            <td>
              {% if row.perm_labels %}
                {% for lbl in row.perm_labels %}<div>{{ lbl }}</div>{% endfor %}
              {% else %}-{% endif %}
            </td>
            <td>{{ row.member_count }}</td>
            <td>
              <div class="actions-wrap">
                <form method="get">
                  <input type="hidden" name="group_id" value="{{ row.group.id }}">
                  <button class="btn small" type="submit">Bewerk</button>
                </form>
                <form method="post" action="{% url 'group_delete' row.group.id %}" style="display:inline;"
                      onsubmit="return confirmGroupDelete('{{ row.group.name|escapejs }}');">
                  {% csrf_token %}
                  <button class="btn small danger" type="submit">Verwijderen</button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </table>
      </div>
    </div>

    <!-- Gebruikers -->
    <div class="card">
      <div class="card-inner">
        <h3 style="margin-top:0;">Gebruiker toevoegen</h3>
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="form_kind" value="user_create">

          {{ user_form.non_field_errors }}
          {{ user_form.errors }}

          <div class="form" style="padding:0;">
            {{ user_form.first_name.label_tag }} {{ user_form.first_name }}
            {{ user_form.email.label_tag }} {{ user_form.email }}
            {{ user_form.password.label_tag }} {{ user_form.password }}
            {{ user_form.group.label_tag }} {{ user_form.group }}
            <button class="btn" type="submit">Aanmaken</button>
          </div>
        </form>

        <hr style="border-color:var(--border); margin:16px 0;">
        <h3 style="margin-top:0;">Bestaande gebruikers</h3>

        <div class="search-bar">
          <input type="text" id="userSearch" placeholder="Typ om te zoekenâ€¦">
        </div>

        <table class="manage-table user-table" id="userTable">
          <tr>
            <th>Voornaam</th>
            <th>E-mail</th>
            <th>Groep</th>
            <th>Acties</th>
          </tr>

          {% for u in users %}
          <tr class="user-row" id="user-row-{{ u.id }}">
            <td title="{{ u.username }}">{{ u.first_name|default:u.username }}</td>
            <td title="{{ u.email }}">{{ u.email }}</td>
            <td>
              {% with g=u.groups.all|first %}
                {{ g.name|default:"-" }}
              {% endwith %}
            </td>
            <td>
              <div class="actions-wrap">
                <button type="button" class="btn small" onclick="toggleEdit('{{ u.id }}')">Bewerk</button>
                <form method="post" action="{% url 'user_delete' u.id %}" style="display:inline;"
                      onsubmit="return confirmDelete('{{ u.first_name|default:u.username }}');">
                  {% csrf_token %}
                  <button class="btn small danger" type="submit">Verwijderen</button>
                </form>
              </div>
            </td>
          </tr>

          <tr id="edit-row-{{ u.id }}" class="edit-row" style="display:none;">
            <td colspan="4">
              <form method="post" action="{% url 'user_update' u.id %}">
                {% csrf_token %}
                <div class="edit-grid">
                  <div>
                    <label>Voornaam</label>
                    <input class="admin-input" type="text" name="first_name" value="{{ u.first_name|default:u.username }}">
                  </div>
                  <div>
                    <label>E-mail</label>
                    <input class="admin-input" type="email" name="email" value="{{ u.email }}">
                  </div>
                  <div>
                    <label>Groep</label>
                    <select name="group" class="admin-select narrow">
                      {% with g=u.groups.all|first %}
                        {% for grp in groups %}
                          <option value="{{ grp.id }}" {% if g and g.id == grp.id %}selected{% endif %}>{{ grp.name }}</option>
                        {% endfor %}
                      {% endwith %}
                    </select>
                  </div>
                </div>
                <div class="edit-actions" style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
                  <button class="btn" type="submit">Opslaan</button>
                  <button type="button" class="btn" onclick="toggleEdit('{{ u.id }}')">Annuleren</button>
                </div>
              </form>
            </td>
          </tr>
          {% endfor %}
        </table>
      </div>
    </div>

  </div>
</div>
{% endblock %}