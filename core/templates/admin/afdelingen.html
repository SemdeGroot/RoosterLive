{% extends "base.html" %}
{% load static role_tags form_extras %}
{% block title %}Afdelingen beheren{% endblock %}
{% block header_title %}Afdelingen beheren{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{% static 'css/base/table.css' %}">
  <link rel="stylesheet" href="{% static 'css/admin/admin_panel.css' %}">
  <script src="{% static 'js/base/table.js' %}" defer></script>
  <script src="{% static 'js/admin/admin_panel.js' %}" defer></script>
{% endblock %}

{% block content %}

<div class="admin-wrap">
    <div class="card">
      <div class="card-inner">
            <div class="birthday-header agenda-section-header">
                <img src="{% static 'img/afdeling.svg' %}" alt="" class="birthday-icon">
                <div class="birthday-header-text">
                    <h2>Afdelingen beheren</h2>
                    <p>Voeg hier afdelingen toe of bewerk de gegevens.</p>
                </div>
                <a href="{% url 'beheer_tiles' %}" class="btn btn-save">
                    Terug naar dashboard
                </a>
            </div>
            <hr class="crud-divider">

        <h3 style="margin-top:0;">Afdeling toevoegen</h3>

        <form method="post" autocomplete="off">
          {% csrf_token %}
          <input type="hidden" name="form_kind" value="afdeling">

          <div class="form form-sticky-actions" style="padding:0;">
            
            <div class="admin-grid" style="margin-bottom: 12px;">
                <div>
                    <label for="{{ afdeling_form.afdeling.id_for_label }}">Afdelingsnaam (zelfde als in Medimo!):</label>
                    {{ afdeling_form.afdeling }}
                </div>
                <div>
                    <label for="{{ afdeling_form.code.id_for_label }}">Code (max. 10 tekens):</label>
                    {{ afdeling_form.code }}
                </div>
            </div>
            
            <div class="admin-grid" style="margin-bottom: 12px;">
                <div>
                    <label for="{{ afdeling_form.organisatie.id_for_label }}">Overkoepelende zorginstelling:</label>
                    {{ afdeling_form.organisatie }}
                </div>
                <div>
                     <label for="{{ afdeling_form.locatie.id_for_label }}">Locatie:</label>
                     {{ afdeling_form.locatie }}
                </div>
            </div>

            <div class="admin-grid" style="margin-bottom: 12px;">
                <div>
                    <label for="{{ afdeling_form.telefoon.id_for_label }}">Telefoon (optioneel):</label>
                    {{ afdeling_form.telefoon }}
                </div>
                <div>
                    <label for="{{ afdeling_form.email.id_for_label }}">E-mail (optioneel):</label>
                    {{ afdeling_form.email }}
                </div>
            </div>

            <div class="admin-grid">
                <div>
                    <label for="{{ afdeling_form.email2.id_for_label }}">E-mail 2 (optioneel):</label>
                    {{ afdeling_form.email2 }}
                </div>
                <div>
                    </div>
            </div>

            <button class="btn btn-save btn-block" type="submit" style="margin-top: 10px;">Toevoegen</button>
          </div>
        </form>

        <hr class="crud-divider">
        <h3 style="margin-top:0;">Bestaande afdelingen</h3>

        <div class="search-bar">
          <input type="text" id="afdelingSearch" placeholder="Zoek op afdeling, code, locatie of organisatieâ€¦" class="admin-input">
        </div>

        <div data-crud data-table="#afdelingTable" data-rows="#afdelingTable .afdeling-row" data-page-size="10">
          <div class="table-scroll">
            <table class="crud-table compact afdeling-table" id="afdelingTable">
              <thead>
                <tr>
                  <th>Afdeling</th>
                  <th>Code</th>
                  <th>Locatie</th>
                  <th>Zorginstelling</th>
                  <th data-nosort>Acties</th>
                </tr>
              </thead>

              <tbody>
                {% for afd in afdelingen %}
                <tr class="afdeling-row" id="afdeling-row-{{ afd.id }}">
                  <td style="font-weight: 600;">{{ afd.afdeling }}</td>
                  <td>{{ afd.code|default:"-" }}</td>
                  <td>{{ afd.locatie|default:"-" }}</td>
                  <td>{{ afd.organisatie.name|default:"-" }}</td>

                  <td>
                    {% if can_manage %}
                    <div class="actions-wrap horizontal">
                      <button type="button" 
                              class="icon-btn" 
                              onclick="toggleAfdelingEdit('{{ afd.id }}')"
                              aria-label="Bewerken">
                          <svg viewBox="0 0 24 24" width="16" height="16" fill="none"
                               stroke="currentColor" stroke-width="2"
                               stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 20h9"/>
                            <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/>
                          </svg>
                      </button>

                      <form method="post"
                            action="{% url 'delete_afdeling' afd.id %}"
                            onsubmit="return confirmAfdelingDelete('{{ afd.afdeling|escapejs }}');">
                        {% csrf_token %}
                        <button class="icon-btn danger" type="submit" aria-label="Verwijderen">
                          <svg viewBox="0 0 24 24" width="16" height="16" fill="none"
                               stroke="currentColor" stroke-width="2"
                               stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            <line x1="10" y1="11" x2="10" y2="17"/>
                            <line x1="14" y1="11" x2="14" y2="17"/>
                          </svg>
                        </button>
                      </form>
                    </div>
                    {% else %}
                        <span style="color:var(--muted); font-size: 0.9em; font-style:italic;">Geen rechten</span>
                    {% endif %}
                  </td>
                </tr>

                <tr id="afdeling-edit-row-{{ afd.id }}" class="edit-row" style="display:none;">
                  <td colspan="5">
                    <div class="edit-wrap">
                      <form method="post" action="{% url 'afdeling_update' afd.id %}">
                        {% csrf_token %}

                        <div class="edit-grid">
                            <div>
                                <label>Afdelingsnaam (zelfde als in Medimo!):</label>
                                <input class="admin-input" type="text" name="afdeling" 
                                       value="{{ afd.afdeling }}" required style="margin-top:6px;">
                            </div>
                            <div>
                                <label>Code (max. 10 tekens):</label>
                                <input class="admin-input" type="text" name="code" 
                                       value="{{ afd.code|default:'' }}" maxlength="10" style="margin-top:6px;">
                            </div>
                            <div>
                                <label>Overkoepelende zorginstelling:</label>
                                <select name="organisatie" class="admin-select" required style="margin-top:6px;">
                                    {% for org in all_organizations %}
                                        <option value="{{ org.id }}" {% if afd.organisatie_id == org.id %}selected{% endif %}>
                                            {{ org.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div>
                                <label>Locatie:</label>
                                <input class="admin-input" type="text" name="locatie" 
                                       value="{{ afd.locatie }}" style="margin-top:6px;">
                            </div>
                            <div>
                                <label>Telefoon (optioneel):</label>
                                <input class="admin-input" type="text" name="telefoon" 
                                       value="{{ afd.telefoon|default:'' }}" style="margin-top:6px;">
                            </div>

                            <div>
                                <label>E-mail (optioneel):</label>
                                <input class="admin-input" type="email" name="email" 
                                       value="{{ afd.email|default:'' }}" style="margin-top:6px;">
                            </div>
                            <div>
                                <label>E-mail 2 (optioneel):</label>
                                <input class="admin-input" type="email" name="email2" 
                                       value="{{ afd.email2|default:'' }}" style="margin-top:6px;">
                            </div>
                        </div>

                        <div class="actions-wrap horizontal" style="margin-top:12px;">
                          <button class="btn btn-save" type="submit">Opslaan</button>
                          <button type="button" class="btn btn-danger" onclick="toggleAfdelingEdit('{{ afd.id }}')">Annuleren</button>
                        </div>
                      </form>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="crud-more-wrap">
            <button class="btn" type="button" data-crud-more>Toon meer</button>
          </div>
        </div>

      </div>
    </div>
</div>
{% endblock %}