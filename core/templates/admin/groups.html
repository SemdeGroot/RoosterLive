{% extends "base.html" %}
{% load static role_tags form_extras %}
{% block title %}Groepen beheren{% endblock %}
{% block header_title %}Groepen beheren{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{% static 'css/base/table.css' %}">
  <link rel="stylesheet" href="{% static 'css/admin/admin_panel.css' %}">
  <script src="{% static 'js/base/table.js' %}" defer></script>
  <script src="{% static 'js/admin/admin_panel.js' %}" defer></script>
{% endblock %}

{% block content %}

<div class="admin-wrap">
    <div class="card">
      <div class="card-inner">
            <div class="birthday-header agenda-section-header">
                <span
                  class="birthday-icon icon-badge i-teal"
                  style="--icon: url('{% static 'img/lucide/team-lucide.svg' %}');"
                  aria-hidden="true">
                </span>
                <div class="birthday-header-text">
                    <h2>Permissie groepen beheren</h2>
                    <p>Voeg hier permissie groepen toe, bewerk permissies en stel de standaard inlog rol in.</p>
                </div>
                <a href="{% url 'beheer_tiles' %}" class="btn btn-save">
                    Terug naar Beheer
                </a>
            </div>
            
        <hr class="crud-divider">

        <h3 style="margin-top:0;">{% if editing_group %}Permissie groep bewerken{% else %}Permissie groep toevoegen{% endif %}</h3>

        <form method="post" autocomplete="off">
          {% csrf_token %}
          <input type="hidden" name="form_kind" value="group">
          {% if editing_group_id %}
            <input type="hidden" name="group_id" value="{{ editing_group_id }}">
          {% endif %}

          {{ group_form.non_field_errors }}
          {{ group_form.errors }}

          <div class="form form-sticky-actions" style="padding:0;">
            <label for="{{ group_form.name.id_for_label }}">Groepsnaam:</label>
            {{ group_form.name }}

            <strong style="font-size:1.1rem; display:block; margin-top:0px;">Permissies</strong>

            {% for section_title, fields in perm_sections %}
              <div class="perm-section-title">{{ section_title }}</div>
              <div class="perms-grid">
                {% for code in fields %}
                  {% if group_form.fields|has_key:code %}
                    {% with bf=group_form|field:code %}
                      {% if bf %}
                        <label class="perm-row">
                          {{ bf }}
                          <span>{{ perm_labels|get_item:code|default:bf.label|default:code }}</span>
                        </label>
                      {% endif %}
                    {% endwith %}
                  {% endif %}
                {% endfor %}
              </div>
            {% endfor %}

            <button class="btn btn-save btn-block" type="submit" style="margin-top: 20px;">Opslaan</button>
            {% if editing_group %}
                <a href="{% url 'admin_groups' %}" class="btn btn-danger btn-block" style="text-align:center; margin-top:12px;">Annuleren</a>
            {% endif %}
          </div>
        </form>

        {% if can_manage %}
        <hr class="crud-divider">
        <h3 style="margin-top:0;">Snelle Inlog Configureren</h3>
        
        <form method="post" autocomplete="off">
            {% csrf_token %}
            <input type="hidden" name="form_kind" value="standaard_inlog">
            
            <div class="form form-sticky-actions" style="padding:0;">
                <label for="{{ inlog_form.standaard_rol.id_for_label }}">{{ inlog_form.standaard_rol.label }}</label>
                {{ inlog_form.standaard_rol }}
                
                <p style="margin-top: 4px; margin-bottom: 16px; font-size: 0.9em; color: var(--muted); line-height: 1.4;">
                    <strong>⚠️ Let op:</strong> Met deze rol en bijbehorende permissies kan <u>iedereen in de apotheek</u> (SL en LW) inloggen met 1 druk op de knop. 
                    Geef deze rol dus <strong>niet te veel rechten</strong> (bijvoorbeeld géén toegang tot Beheer of Medicatiebeoordeling)!
                </p>
                
                <button type="submit" class="btn btn-save btn-block">Instellen</button>
            </div>
        </form>
        {% endif %}

        <hr class="crud-divider">
        
        <h3 style="margin-top:0;">Bestaande groepen</h3>

        <div class="search-bar">
          <input type="text" id="groupSearch" placeholder="Typ om te zoeken…">
        </div>

        <div data-crud data-table="#groupTable" data-rows="#groupTable .group-row" data-page-size="10">
          <div class="table-scroll">
            <table class="crud-table compact group-table" id="groupTable">
              <thead>
                <tr>
                  <th>Groep</th>
                  <th>Permissies</th>
                  <th class="center-col">Leden</th>
                  <th data-nosort>Acties</th>
                </tr>
              </thead>

              <tbody>
                {% for row in group_rows %}
                <tr class="group-row" id="group-row-{{ row.group.id }}">
                  <td>
                    {{ row.group.name }}
                    
                    {% if selected_kiosk_id == row.group.id %}
                        <span style="background:#ffc107; color:#000; padding:2px 6px; border-radius:4px; font-size:0.7em; font-weight:bold; margin-left:8px; vertical-align:middle; text-transform: uppercase;">
                            Snelle Inlog
                        </span>
                    {% endif %}
                  </td>

                  <td class="wrap">
                    {% if row.perm_labels %}
                      {% for lbl in row.perm_labels %}<div>{{ lbl }}</div>{% endfor %}
                    {% else %}
                      -
                    {% endif %}
                  </td>

                  <td class="center-col">{{ row.member_count }}</td>

                  <td>
                    {% if can_manage %}
                    <div class="actions-wrap horizontal">
                      <form method="get">
                        <input type="hidden" name="group_id" value="{{ row.group.id }}">
                        <button class="icon-btn" type="submit" aria-label="Bewerken">
                          <svg viewBox="0 0 24 24" width="16" height="16" fill="none"
                               stroke="currentColor" stroke-width="2"
                               stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 20h9"/>
                            <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/>
                          </svg>
                        </button>
                      </form>

                      <form method="post"
                            action="{% url 'group_delete' row.group.id %}"
                            onsubmit="return confirmGroupDelete('{{ row.group.name|escapejs }}');">
                        {% csrf_token %}
                        <button class="icon-btn danger" type="submit" aria-label="Verwijderen">
                          <svg viewBox="0 0 24 24" width="16" height="16" fill="none"
                               stroke="currentColor" stroke-width="2"
                               stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            <line x1="10" y1="11" x2="10" y2="17"/>
                            <line x1="14" y1="11" x2="14" y2="17"/>
                          </svg>
                        </button>
                      </form>
                    </div>
                    {% else %}
                        <span style="color:var(--muted); font-size: 0.9em; font-style:italic;">Geen rechten</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="crud-more-wrap">
            <button class="btn" type="button" data-crud-more>Toon meer</button>
          </div>
        </div>

      </div>
    </div>
</div>
{% endblock %}