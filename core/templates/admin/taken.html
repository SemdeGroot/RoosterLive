{% extends "base.html" %}
{% load static role_tags form_extras %}
{% block title %}Taken beheren{% endblock %}
{% block header_title %}Taken beheren{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{% static 'css/base/table.css' %}">
  <link rel="stylesheet" href="{% static 'css/admin/admin_panel.css' %}">
  <script src="{% static 'js/base/table.js' %}" defer></script>
  <script src="https://unpkg.com/imask"></script>
  <script src="{% static 'js/admin/admin_panel.js' %}" defer></script>
{% endblock %}

{% block content %}

<div class="admin-wrap">
  <div class="card">
    <div class="card-inner">

      <div class="birthday-header agenda-section-header">
        <span
          class="birthday-icon icon-badge i-amber"
          style="--icon: url('{% static 'img/lucide/admin_taken-lucide.svg' %}');"
          aria-hidden="true">
        </span>
        <div class="birthday-header-text">
          <h2>Taken beheren</h2>
          <p>Beheer locaties, dagdelen en taken (taken zijn gekoppeld aan een locatie).</p>
        </div>
        <a href="{% url 'beheer_tiles' %}" class="btn btn-save">
          Terug naar Beheer
        </a>
      </div>

      <hr class="crud-divider">

      <!-- =========================
           LOCATIE TOEVOEGEN
      ========================== -->
      <h3 style="margin-top:0;">Locatie toevoegen</h3>

      <form method="post" autocomplete="off">
        {% csrf_token %}
        <input type="hidden" name="form_kind" value="location">

        <div class="form form-sticky-actions" style="padding:0;">
          <div class="admin-grid" style="margin-bottom: 12px;">
            <div>
              <label for="{{ location_form.name.id_for_label }}">Locatienaam:</label>
              {{ location_form.name }}
            </div>
            <div>
              <label for="{{ location_form.address.id_for_label }}">Adres:</label>
              {{ location_form.address }}
            </div>
            <div>
              <label for="{{ location_form.color.id_for_label }}">Kleur:</label>
              {{ location_form.color }}
            </div>
          </div>

          <button class="btn btn-save btn-block" type="submit" style="margin-top: 10px;">
            Toevoegen
          </button>
        </div>
      </form>

      <hr class="crud-divider">

      <!-- =========================
           BESTAANDE LOCATIES
      ========================== -->
      <h3 style="margin-top:0;">Bestaande locaties</h3>

      <div class="search-bar">
        <input type="text" id="locationSearch" placeholder="Zoek op locatie…" class="admin-input">
      </div>

      <div data-crud data-table="#locationTable" data-rows="#locationTable .location-row" data-page-size="10">
        <div class="table-scroll">
          <table class="crud-table compact location-table" id="locationTable">
            <thead>
              <tr>
                <th>Locatie</th>
                <th>Adres</th>
                <th>Kleur</th>
                <th data-nosort>Acties</th>
              </tr>
            </thead>

            <tbody>
              {% for loc in locations %}
              <tr class="location-row" id="location-row-{{ loc.id }}">
                <td style="font-weight: 600;">{{ loc.name }}</td>
                <td>{{ loc.address|default:"-" }}</td>
                <td>{{ loc.get_color_display }}</td>
                <td>
                  {% if can_manage %}
                  <div class="actions-wrap horizontal">
                    <button type="button"
                            class="icon-btn"
                            onclick="toggleLocationEdit('{{ loc.id }}')"
                            aria-label="Bewerken">
                      <svg viewBox="0 0 24 24" width="16" height="16" fill="none"
                           stroke="currentColor" stroke-width="2"
                           stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 20h9"/>
                        <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/>
                      </svg>
                    </button>

                    <form method="post"
                          action="{% url 'delete_location' loc.id %}"
                          onsubmit="return confirmLocationDelete('{{ loc.name|escapejs }}');">
                      {% csrf_token %}
                      <button class="icon-btn danger" type="submit" aria-label="Verwijderen">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none"
                             stroke="currentColor" stroke-width="2"
                             stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="3 6 5 6 21 6"/>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                          <line x1="10" y1="11" x2="10" y2="17"/>
                          <line x1="14" y1="11" x2="14" y2="17"/>
                        </svg>
                      </button>
                    </form>
                  </div>
                  {% else %}
                    <span style="color:var(--muted); font-size: 0.9em; font-style:italic;">Geen rechten</span>
                  {% endif %}
                </td>
              </tr>

              <tr id="location-edit-row-{{ loc.id }}" class="edit-row" style="display:none;">
                <td colspan="4">
                  <div class="edit-wrap">
                    <form method="post" action="{% url 'location_update' loc.id %}">
                      {% csrf_token %}

                      <div class="edit-grid">
                        <div>
                          <label>Locatienaam:</label>
                          <input class="admin-input" type="text" name="name"
                                 value="{{ loc.name }}" required style="margin-top:6px;">
                        </div>

                        <div>
                          <label>Adres (optioneel):</label>
                          <input class="admin-input" type="text" name="address"
                                 value="{{ loc.address|default:'' }}" style="margin-top:6px;">
                        </div>
                        <div>
                        <label>Kleur:</label>
                        <select name="color" class="admin-select" required style="margin-top:6px;">
                          <option value="green" {% if loc.color == "green" %}selected{% endif %}>Groen</option>
                          <option value="red"   {% if loc.color == "red" %}selected{% endif %}>Rood</option>
                          <option value="blue"  {% if loc.color == "blue" %}selected{% endif %}>Blauw</option>
                        </select>
                      </div>
                      </div>

                      <div class="actions-wrap horizontal" style="margin-top:12px;">
                        <button class="btn btn-save" type="submit">Opslaan</button>
                        <button type="button" class="btn btn-danger" onclick="toggleLocationEdit('{{ loc.id }}')">
                          Annuleren
                        </button>
                      </div>
                    </form>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="crud-more-wrap">
          <button class="btn" type="button" data-crud-more>Toon meer</button>
        </div>
      </div>

      <hr class="crud-divider">

      <!-- =========================
           SHIFTS (DAGDELEN) - alleen tijden + toeslag editbaar
      ========================== -->
      <h3 style="margin-top:0;">Shifts (dagdelen)</h3>
      <p class="admin-help">
        De namen en volgorde staan vast. Je kunt alleen start/eind en de CAO-toeslag aanpassen.
      </p>

      <div class="table-scroll">
        <table class="crud-table compact dagdeel-table" id="dagdeelTable">
          <thead>
            <tr>
              <th>Shift</th>
              <th>Start</th>
              <th>Eind</th>
              <th>Toeslag %</th>
              <th data-nosort>Acties</th>
            </tr>
          </thead>

          <tbody>
            {% for d in dagdelen %}
            <tr class="dagdeel-row" id="dagdeel-row-{{ d.code }}">
              <td style="font-weight:600;">{{ d.get_code_display }}</td>
              <td>{{ d.start_time|time:"H:i" }}</td>
              <td>{{ d.end_time|time:"H:i" }}</td>
              <td>{{ d.allowance_pct }}%</td>
              <td>
                {% if can_manage %}
                <div class="actions-wrap horizontal">
                  <button type="button"
                          class="icon-btn"
                          onclick="toggleDagdeelEdit('{{ d.code }}')"
                          aria-label="Bewerken">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none"
                         stroke="currentColor" stroke-width="2"
                         stroke-linecap="round" stroke-linejoin="round">
                      <path d="M12 20h9"/>
                      <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/>
                    </svg>
                  </button>
                </div>
                {% else %}
                  <span style="color:var(--muted); font-size: 0.9em; font-style:italic;">Geen rechten</span>
                {% endif %}
              </td>
            </tr>

            <tr id="dagdeel-edit-row-{{ d.code }}" class="edit-row" style="display:none;">
              <td colspan="5">
                <div class="edit-wrap">
                  <form method="post" action="{% url 'dagdeel_update' d.code %}">
                    {% csrf_token %}

                    <div class="edit-grid">
                      <div>
                        <label>Starttijd:</label>
                        <input class="admin-input js-time" type="text" inputmode="numeric" name="start_time"
                              value="{{ d.start_time|time:'H:i' }}" placeholder="uu:mm" required>
                      </div>

                      <div>
                        <label>Eindtijd:</label>
                        <input class="admin-input js-time" type="text" inputmode="numeric" name="end_time"
                              value="{{ d.end_time|time:'H:i' }}" placeholder="uu:mm" required>
                      </div>

                      <div>
                        <label>Toeslag %:</label>
                        <input class="admin-input" type="number" min="0" max="300" step="1" name="allowance_pct"
                               value="{{ d.allowance_pct }}" required>
                        <small class="admin-help">100 = geen toeslag, 120 = 20% toeslag.</small>
                      </div>
                    </div>

                    <div class="actions-wrap horizontal" style="margin-top:12px;">
                      <button class="btn btn-save" type="submit">Opslaan</button>
                      <button type="button" class="btn btn-danger" onclick="toggleDagdeelEdit('{{ d.code }}')">
                        Annuleren
                      </button>
                    </div>
                  </form>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <hr class="crud-divider">

      <!-- =========================
           TAAK TOEVOEGEN
      ========================== -->
      <h3 style="margin-top:0;">Taak toevoegen</h3>

      <form method="post" autocomplete="off">
        {% csrf_token %}
        <input type="hidden" name="form_kind" value="task">

        <div class="form form-sticky-actions" style="padding:0;">

          <!-- Taaknaam + Locatie -->
          <div class="admin-grid" style="margin-bottom: 12px;">
            <div>
              <label for="{{ task_form.name.id_for_label }}">Taaknaam:</label>
              {{ task_form.name }}
            </div>
            <div>
              <label for="{{ task_form.location.id_for_label }}">Locatie:</label>
              {{ task_form.location }}
            </div>
          </div>

          <!-- Omschrijving -->
          <div class="admin-grid" style="margin-bottom: 12px;">
            <div style="grid-column: 1 / -1;">
              <label for="{{ task_form.description.id_for_label }}">Omschrijving (optioneel):</label>
              {{ task_form.description }}
            </div>
          </div>

          <!-- Minimale bezetting (grid van 3) -->
          <div class="staffing-block">
            <div class="staffing-title">Minimale bezetting</div>

            <div class="staffing-grid">
              <div class="staffing-head"></div>
              <div class="staffing-head">Ochtend</div>
              <div class="staffing-head">Middag</div>
              <div class="staffing-head">Avond</div>

              <div class="staffing-day">Maandag</div>
              {{ task_form.min_mon_morning }}
              {{ task_form.min_mon_afternoon }}
              {{ task_form.min_mon_evening }}

              <div class="staffing-day">Dinsdag</div>
              {{ task_form.min_tue_morning }}
              {{ task_form.min_tue_afternoon }}
              {{ task_form.min_tue_evening }}

              <div class="staffing-day">Woensdag</div>
              {{ task_form.min_wed_morning }}
              {{ task_form.min_wed_afternoon }}
              {{ task_form.min_wed_evening }}

              <div class="staffing-day">Donderdag</div>
              {{ task_form.min_thu_morning }}
              {{ task_form.min_thu_afternoon }}
              {{ task_form.min_thu_evening }}

              <div class="staffing-day">Vrijdag</div>
              {{ task_form.min_fri_morning }}
              {{ task_form.min_fri_afternoon }}
              {{ task_form.min_fri_evening }}

              <div class="staffing-day">Zaterdag</div>
              {{ task_form.min_sat_morning }}
              {{ task_form.min_sat_afternoon }}
              {{ task_form.min_sat_evening }}
            </div>
          </div>

          <button class="btn btn-save btn-block" type="submit" style="margin-top: 10px;">
            Toevoegen
          </button>
        </div>
      </form>

      <hr class="crud-divider">

      <!-- =========================
           BESTAANDE TAKEN
      ========================== -->
      <h3 style="margin-top:0;">Bestaande taken</h3>

      <div class="search-bar">
        <input type="text" id="taskSearch" placeholder="Zoek op taak, locatie of omschrijving…" class="admin-input">
      </div>

      <div data-crud data-table="#taskTable" data-rows="#taskTable .task-row" data-page-size="10">
        <div class="table-scroll">
          <table class="crud-table compact task-table" id="taskTable">
            <thead>
              <tr>
                <th>Taak</th>
                <th>Locatie</th>
                <th>Omschrijving</th>
                <th data-nosort>Acties</th>
              </tr>
            </thead>

            <tbody>
              {% for t in tasks %}
              <tr class="task-row" id="task-row-{{ t.id }}">
                <td style="font-weight:600;">{{ t.name }}</td>
                <td>{{ t.location.name }}</td>
                <td>{{ t.description|default:"-" }}</td>

                <td>
                  {% if can_manage %}
                  <div class="actions-wrap horizontal">
                    <button type="button"
                            class="icon-btn"
                            onclick="toggleTaskEdit('{{ t.id }}')"
                            aria-label="Bewerken">
                      <svg viewBox="0 0 24 24" width="16" height="16" fill="none"
                           stroke="currentColor" stroke-width="2"
                           stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 20h9"/>
                        <path d="M16.5 3.5a2.1 2 0 0 1 3 3L7 19l-4 1 1-4Z"/>
                      </svg>
                    </button>

                    <form method="post"
                          action="{% url 'delete_task' t.id %}"
                          onsubmit="return confirmTaskDelete('{{ t.name|escapejs }}');">
                      {% csrf_token %}
                      <button class="icon-btn danger" type="submit" aria-label="Verwijderen">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none"
                             stroke="currentColor" stroke-width="2"
                             stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="3 6 5 6 21 6"/>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                          <line x1="10" y1="11" x2="10" y2="17"/>
                          <line x1="14" y1="11" x2="14" y2="17"/>
                        </svg>
                      </button>
                    </form>
                  </div>
                  {% else %}
                    <span style="color:var(--muted); font-size: 0.9em; font-style:italic;">Geen rechten</span>
                  {% endif %}
                </td>
              </tr>

              <tr id="task-edit-row-{{ t.id }}" class="edit-row" style="display:none;">
                <td colspan="4">
                  <div class="edit-wrap">
                    <form method="post" action="{% url 'task_update' t.id %}">
                      {% csrf_token %}

                      <div class="edit-grid">
                        <div>
                          <label>Taaknaam:</label>
                          <input class="admin-input" type="text" name="name"
                                 value="{{ t.name }}" required style="margin-top:6px;">
                        </div>

                        <div>
                          <label>Locatie:</label>
                          <select name="location" class="admin-select" required style="margin-top:6px;">
                            {% for loc in locations %}
                              <option value="{{ loc.id }}" {% if t.location_id == loc.id %}selected{% endif %}>
                                {{ loc.name }}
                              </option>
                            {% endfor %}
                          </select>
                        </div>

                        <div style="grid-column: 1 / -1;">
                          <label>Omschrijving (optioneel):</label>
                          <textarea name="description" class="admin-input" rows="3" style="margin-top:6px;">{{ t.description|default:'' }}</textarea>
                        </div>
                      </div>

                      <!-- Minimale bezetting -->
                      <div class="staffing-block">
                        <div class="staffing-title">Minimale bezetting</div>

                        <div class="staffing-grid">
                          <div class="staffing-head"></div>
                          <div class="staffing-head">Ochtend</div>
                          <div class="staffing-head">Middag</div>
                          <div class="staffing-head">Avond</div>

                          <div class="staffing-day">Maandag</div>
                          <input class="admin-input" type="number" min="0" step="1" name="min_mon_morning" value="{{ t.min_mon_morning }}">
                          <input class="admin-input" type="number" min="0" step="1" name="min_mon_afternoon" value="{{ t.min_mon_afternoon }}">
                          <input class="admin-input" type="number" min="0" step="1" name="min_mon_evening" value="{{ t.min_mon_evening }}">

                          <div class="staffing-day">Dinsdag</div>
                          <input class="admin-input" type="number" min="0" step="1" name="min_tue_morning" value="{{ t.min_tue_morning }}">
                          <input class="admin-input" type="number" min="0" step="1" name="min_tue_afternoon" value="{{ t.min_tue_afternoon }}">
                          <input class="admin-input" type="number" min="0" step="1" name="min_tue_evening" value="{{ t.min_tue_evening }}">

                          <div class="staffing-day">Woensdag</div>
                          <input class="admin-input" type="number" min="0" step="1" name="min_wed_morning" value="{{ t.min_wed_morning }}">
                          <input class="admin-input" type="number" min="0" step="1" name="min_wed_afternoon" value="{{ t.min_wed_afternoon }}">
                          <input class="admin-input" type="number" min="0" step="1" name="min_wed_evening" value="{{ t.min_wed_evening }}">

                          <div class="staffing-day">Donderdag</div>
                          <input class="admin-input" type="number" min="0" step="1" name="min_thu_morning" value="{{ t.min_thu_morning }}">
                          <input class="admin-input" type="number" min="0" step="1" name="min_thu_afternoon" value="{{ t.min_thu_afternoon }}">
                          <input class="admin-input" type="number" min="0" step="1" name="min_thu_evening" value="{{ t.min_thu_evening }}">

                          <div class="staffing-day">Vrijdag</div>
                          <input class="admin-input" type="number" min="0" step="1" name="min_fri_morning" value="{{ t.min_fri_morning }}">
                          <input class="admin-input" type="number" min="0" step="1" name="min_fri_afternoon" value="{{ t.min_fri_afternoon }}">
                          <input class="admin-input" type="number" min="0" step="1" name="min_fri_evening" value="{{ t.min_fri_evening }}">

                          <div class="staffing-day">Zaterdag</div>
                          <input class="admin-input" type="number" min="0" step="1" name="min_sat_morning" value="{{ t.min_sat_morning }}">
                          <input class="admin-input" type="number" min="0" step="1" name="min_sat_afternoon" value="{{ t.min_sat_afternoon }}">
                          <input class="admin-input" type="number" min="0" step="1" name="min_sat_evening" value="{{ t.min_sat_evening }}">
                        </div>
                      </div>

                      <div class="actions-wrap horizontal" style="margin-top:12px;">
                        <button class="btn btn-save" type="submit">Opslaan</button>
                        <button type="button" class="btn btn-danger" onclick="toggleTaskEdit('{{ t.id }}')">
                          Annuleren
                        </button>
                      </div>
                    </form>
                  </div>
                </td>
              </tr>

              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="crud-more-wrap">
          <button class="btn" type="button" data-crud-more>Toon meer</button>
        </div>
      </div>

    </div>
  </div>
</div>

{% endblock %}