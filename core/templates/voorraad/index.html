{% extends "base.html" %}
{% load static %}
{% block title %}{{ title }}{% endblock %}
{% block header_title %}{{ title }}{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{% static 'css/base/table.css' %}">
  <link rel="stylesheet" href="{% static 'css/voorraad/voorraad.css' %}">
  <script src="{% static 'js/base/table.js' %}" defer></script>
  <script src="{% static 'js/voorraad/voorraad.js' %}" defer></script>

  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'css/base/select2_dropdown.css' %}">
{% endblock %}

{% block content %}
<div class="card" style="padding: 16px;">
        <div class="birthday-header agenda-section-header">
        <span
          class="birthday-icon icon-badge i-blue"
          style="--icon: url('{% static 'img/lucide/voorraad-lucide.svg' %}');"
          aria-hidden="true">
        </span>
        <div class="birthday-header-text">
        <h2>Baxtervoorraad geneesmiddelen</h2>
        <p>Bekijk hier de voorraad geneesmiddelen voor de baxterproductie en de bijbehorende locaties.</p>
        </div>
        <a href="{% url 'baxter_tiles' %}" class="btn btn-save">
          Terug naar Baxterproductie
        </a>
      </div>
      <hr class="crud-divider">

  {% if can_edit %}
  <form method="post" enctype="multipart/form-data" class="uploader" id="medForm">
    {% csrf_token %}
    <input type="file" id="medFile" name="file" accept=".csv,.xlsx,.xls" hidden required>

    <div class="dropzone" id="medDrop" onclick="document.getElementById('medFile').click()">
      <div class="dz-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <path d="M14 2v6h6"/>
          <path d="M12 12v6"/>
          <path d="M9 15h6"/>
        </svg>
      </div>
      <div class="dz-text">
        <div class="dz-title">Sleep je voorraad bestand (.csv of .xlsx.) hierheen of klik om te kiezen.</div>
        <div class="dz-hint">Zorg dat <strong>kolom 1 de ZI-nummers</strong> bevat en <strong>kolom 2 de medicijnnamen. De rest van het portaal is hier op gebasseerd namelijk!</strong> De andere kolommen kun je vrij invullen.</div>
      </div>
    </div>

    <div class="file-meta" id="medMeta" style="display:none;">
      Geselecteerd: <span class="file-name" id="medName"></span>
    </div>

    <div class="u-actions">
      <button class="btn btn-save" type="submit" id="medUpload" disabled>Uploaden</button>
      <button type="button" class="btn btn-danger" id="medClear" style="display:none;">Wissen</button>
    </div>
  </form>
  {% endif %}

  <div class="search-row">
    <input id="medSearch" type="text" placeholder="Typ om te zoeken..." class="admin-input">
  </div>

{% if rows %}
  <div data-crud data-table="#medTable" data-page-size="20">
    <div class="table-scroll">
      <table class="manage-table crud-table" id="medTable">
        <thead>
          <tr>{% for c in columns %}<th>{{ c }}</th>{% endfor %}</tr>
        </thead>
        <tbody>
          {% for r in rows %}
            <tr class="med-row">{% for cell in r %}<td>{{ cell }}</td>{% endfor %}</tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="crud-more-wrap">
      <button type="button" class="btn" data-crud-more>Toon meer</button>
    </div>
  </div> {# <-- sluit data-crud HIER af #}

  {% if can_edit %}
  <div style="display:flex; align-items:center; gap:8px; margin-top:20px;">
    <a href="{% url 'voorraad_export_html' %}" class="btn btn-save">
      Exporteer als HTML
    </a>

    <button
      type="button"
      onclick="toggleEmailModal()"
      class="btn btn-save"
      style="margin-left:auto;"
    >
      Verstuur naar apotheken
    </button>
  </div>
  {% endif %}

  <div id="emailModal" class="modal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.6);">
    <div class="modal-content" style="background-color:var(--panel); margin:10% auto; padding:25px; border:1px solid var(--border); width:90%; border-radius:12px; max-width:600px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);">

      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom: 1px solid var(--border); padding-bottom: 15px;">
        <h2 style="margin:0; font-size: 1.4rem;">Voorraad Versturen</h2>
        <span onclick="toggleEmailModal()" style="cursor:pointer; font-size:28px; font-weight:bold; color:var(--muted); line-height: 1;">&times;</span>
      </div>

      <form action="{% url 'voorraad_email_html' %}" method="post">
        {% csrf_token %}

        <div style="margin-bottom:20px;">
          <label class="select2-label">Selecteer Apotheken</label>

          <div style="margin-bottom:8px; display:flex; gap:10px;">
            <button type="button" class="btn" onclick="selectAllApotheken()">Alles selecteren</button>
            <button type="button" class="btn" onclick="deselectAllApotheken()">Alles wissen</button>
          </div>

          <select name="recipients" id="id_recipients" multiple="multiple" style="width:100%;">
            {% for apo in apotheken %}
              <option value="{{ apo.id }}">
                {{ apo.name }} {% if apo.email %}- {{ apo.email }}{% endif %}
              </option>
            {% endfor %}
          </select>
        </div>

        <div style="text-align:right; margin-top:30px; border-top: 1px solid var(--border); padding-top: 20px;">
          <button type="button" onclick="toggleEmailModal()" class="btn btn-danger" style="margin-right:10px;">Annuleren</button>
          <button type="submit" class="btn btn-save">Versturen</button>
        </div>
      </form>
    </div>
  </div>

{% else %}
  <p style="color:var(--muted); margin:8px 0 0;">Nog geen bestand ge√ºpload.</p>
{% endif %}

</div>
{% endblock %}
{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% endblock %}
